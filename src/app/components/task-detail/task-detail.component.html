<div class="task-detail-container">
  <!-- ヘッダー -->
  <div class="task-header">
    <button mat-button (click)="goBack()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
      戻る
    </button>
    <h1>{{ taskData.taskName || "タスク詳細" }}</h1>
    <div class="header-actions">
      <div class="header-calendar-toggle">
        <button
          type="button"
          class="calendar-switch"
          [class.on]="taskData.calendarSyncEnabled"
          [disabled]="isCalendarSyncSaving"
          (click)="toggleCalendarSync()"
          role="switch"
          [attr.aria-checked]="taskData.calendarSyncEnabled"
        >
          <span class="calendar-switch-handle"></span>
        </button>
        <span class="calendar-switch-label">
          カレンダー連携 {{ taskData.calendarSyncEnabled ? 'ON' : 'OFF' }}
        </span>
      </div>
      <button
        mat-raised-button
        class="edit-button"
        (click)="toggleEdit()"
      >
        <mat-icon>edit</mat-icon>
        編集
      </button>
    </div>
  </div>

  <!-- ローディング状態 -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>タスク情報を読み込み中...</p>
  </div>

  <!-- メインコンテンツ -->
  <div class="task-content" *ngIf="!isLoading && task; else taskNotFound">
    <!-- 基本情報 -->
    <mat-card class="info-card">
      <mat-card-header>
        <mat-card-title>基本情報</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <div class="form-field">
            <label>プロジェクト名</label>
            <div class="readonly-field">
              {{ taskData.projectName || project?.projectName || "—" }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label>タスク名</label>
            <div class="readonly-field">
              {{ taskData.taskName }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label>タスクの説明</label>
            <div class="readonly-field">
              {{ taskData.description || "説明なし" }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label>期間</label>
            <div class="readonly-field">
              {{
                taskData.startDate
                  ? (taskData.startDate | date : "yyyy/MM/dd")
                  : "—"
              }}
              ～
              {{
                taskData.dueDate
                  ? (taskData.dueDate | date : "yyyy/MM/dd")
                  : "—"
              }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label>担当者</label>
            <div class="readonly-field">
              {{ taskData.assignee || "—" }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label>ステータス</label>
            <div class="readonly-field">
              {{ taskData.status }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label>優先度</label>
            <div class="readonly-field">
              {{ taskData.priority }}
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- タグと関連資料 -->
    <mat-card class="info-card">
      <mat-card-header>
        <mat-card-title>タグ・関連資料</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <div class="form-field">
            <label>タグ</label>
            <div *ngIf="isEditing" class="tag-input">
              <input
                matInput
                #tagInput
                placeholder="タグを入力してEnter"
                (keyup.enter)="addTag(tagInput.value); tagInput.value = ''"
              />
            </div>
            <mat-chip-set *ngIf="taskData.tags && taskData.tags.length > 0">
              <mat-chip
                *ngFor="let tag of taskData.tags || []"
                [removable]="isEditing"
                (removed)="removeTag(tag)"
              >
                {{ tag }}
                <mat-icon matChipRemove *ngIf="isEditing">cancel</mat-icon>
              </mat-chip>
            </mat-chip-set>
            <div
              *ngIf="!isEditing && (taskData.tags?.length || 0) === 0"
              class="readonly-field"
            >
              タグなし
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label>格納済み関連資料</label>
            <div *ngIf="isEditing" class="file-input">
              <input
                matInput
                #fileInput
                placeholder="ファイル名を入力してEnter"
                (keyup.enter)="
                  addRelatedFile(fileInput.value); fileInput.value = ''
                "
              />
            </div>
            <mat-chip-set
              *ngIf="taskData.relatedFiles && taskData.relatedFiles.length > 0"
            >
              <mat-chip
                *ngFor="let file of taskData.relatedFiles || []"
                [removable]="isEditing"
                (removed)="removeRelatedFile(file)"
              >
                <mat-icon>attach_file</mat-icon>
                {{ file }}
                <mat-icon matChipRemove *ngIf="isEditing">cancel</mat-icon>
              </mat-chip>
            </mat-chip-set>
            <div
              *ngIf="!isEditing && (taskData.relatedFiles?.length || 0) === 0"
              class="readonly-field"
            >
              関連資料なし
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- アクションボタン -->
    <mat-card class="action-card">
      <mat-card-content>
        <div class="action-buttons">
          <button mat-raised-button (click)="createSubtask()">
            <mat-icon>add</mat-icon>
            子タスク
          </button>
          <button mat-raised-button (click)="duplicateTask()">
            <mat-icon>content_copy</mat-icon>
            複製
          </button>
          <button mat-raised-button (click)="openDetailSettings()">
            <mat-icon>settings</mat-icon>
            詳細設定
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- タスク内チャット -->
    <mat-card class="chat-card">
      <mat-card-header>
        <mat-card-title>タスク内チャット</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <!-- プロジェクトチャットコンポーネントを使用 -->
        <app-project-chat *ngIf="task?.id" [projectId]="task.id!">
        </app-project-chat>
      </mat-card-content>
    </mat-card>

    <!-- 子タスク一覧 -->
    <div
      *ngIf="childTasks.length > 0"
      class="child-tasks-section"
      [style.background]="getChildTasksSectionBackground()"
    >
      <div class="child-tasks-header">
        <h3>子タスク一覧</h3>
        <div class="child-tasks-actions">
          <button mat-raised-button color="accent" (click)="createSubtask()">
            ＋ 子タスク
          </button>
          <button mat-raised-button color="accent" (click)="exportChildTasksToCSV()">
            <mat-icon>download</mat-icon>
            出力
          </button>
        </div>
      </div>

      <div class="child-filter-section">
        <mat-form-field appearance="outline">
          <mat-label>ステータス</mat-label>
          <mat-select
            [(ngModel)]="childFilterStatus"
            (selectionChange)="applyChildFilter()"
          >
            <mat-option value="">すべて</mat-option>
            <mat-option *ngFor="let status of statusOptions" [value]="status">
              {{ status }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>優先度</mat-label>
          <mat-select
            [(ngModel)]="childFilterPriority"
            (selectionChange)="applyChildFilter()"
          >
            <mat-option value="">すべて</mat-option>
            <mat-option *ngFor="let priority of priorityOptions" [value]="priority">
              {{ priority }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>担当者</mat-label>
          <mat-select
            [(ngModel)]="childFilterAssignee"
            (selectionChange)="applyChildFilter()"
          >
            <mat-option value="">すべて</mat-option>
            <mat-option
              *ngFor="let assignee of childAssigneeOptions"
              [value]="assignee"
            >
              {{ assignee }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>期日</mat-label>
          <input
            matInput
            #childDueDateInput
            type="date"
            [(ngModel)]="childFilterDueDate"
            (change)="applyChildFilter()"
          />
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="openChildDatePicker(childDueDateInput)"
            aria-label="期日を選択"
          >
            <mat-icon>event</mat-icon>
          </button>
        </mat-form-field>

        <button mat-stroked-button (click)="resetChildFilter()">
          <mat-icon>refresh</mat-icon>
          リセット
        </button>
      </div>

      <div class="child-tasks-grid" *ngIf="filteredChildTasks.length > 0; else noChildTasks">
        <mat-card
          *ngFor="let child of filteredChildTasks"
          class="child-task-card"
          [ngClass]="{ completed: child.status === '完了' }"
          (click)="openChildTaskDetail(child)"
        >
          <mat-card-header>
            <mat-card-title>{{ child.taskName }}</mat-card-title>
            <mat-card-subtitle>
              <mat-chip-set>
                <mat-chip [color]="getStatusColor(child.status)" selected>
                  {{ child.status }}
                </mat-chip>
                <mat-chip [color]="getPriorityColor(child.priority)" selected>
                  {{ child.priority }}
                </mat-chip>
              </mat-chip-set>
            </mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="child-task-details">
              <div class="child-task-detail-item">
                <mat-icon>event</mat-icon>
                <span>{{ child.dueDate || '未設定' }}</span>
              </div>
              <div class="child-task-detail-item">
                <mat-icon>person</mat-icon>
                <span>{{ child.assignee || '未割当' }}</span>
              </div>
              <div class="child-task-detail-item">
                <mat-icon>description</mat-icon>
                <span>{{ child.description || '説明なし' }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <ng-template #noChildTasks>
        <div class="child-no-tasks">
          <mat-icon>inbox</mat-icon>
          <p>条件に一致する子タスクがありません。</p>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- 詳細設定ダイアログ -->
  <div
    class="detail-settings-overlay"
    *ngIf="isDetailSettingsOpen"
    (click)="closeDetailSettings()"
  >
    <div class="detail-settings-dialog" (click)="$event.stopPropagation()">
      <div class="settings-header">
        <h2>詳細設定</h2>
        <button mat-icon-button (click)="closeDetailSettings()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="settings-content">
        <!-- 通知設定 -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>通知設定</mat-panel-title>
          </mat-expansion-panel-header>
          <div class="setting-item notification-toggle">
            <span class="calendar-toggle-label">タスク期限通知</span>
            <button
              type="button"
              class="calendar-switch"
              [class.on]="detailSettings.notifications.beforeDeadline"
              (click)="toggleTaskDeadlineNotification()"
              role="switch"
              [attr.aria-checked]="detailSettings.notifications.beforeDeadline"
            >
              <span class="calendar-switch-handle"></span>
            </button>
            <span
              class="calendar-toggle-state"
              [class.on]="detailSettings.notifications.beforeDeadline"
            >
              {{ detailSettings.notifications.beforeDeadline ? 'ON' : 'OFF' }}
            </span>
          </div>
          <div class="setting-item notification-select">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>通知先</mat-label>
              <mat-select
                [(ngModel)]="detailSettings.notifications.recipients"
                name="notificationRecipients"
                multiple
                [disabled]="!detailSettings.notifications.beforeDeadline"
                (selectionChange)="onNotificationRecipientsChange()"
              >
                <mat-option
                  *ngFor="let option of notificationRecipientOptions"
                  [value]="option"
                >
                  {{ option }}
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>group</mat-icon>
            </mat-form-field>

            <div
              class="notification-recipient-chips"
              *ngIf="detailSettings.notifications.recipients?.length"
            >
              <mat-chip-set>
                <mat-chip
                  *ngFor="let recipient of detailSettings.notifications.recipients"
                >
                  <mat-icon>person</mat-icon>
                  {{ recipient }}
                </mat-chip>
              </mat-chip-set>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- タスクの順番管理 -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>タスクの順番管理</mat-panel-title>
          </mat-expansion-panel-header>
          <div class="setting-item">
            <mat-checkbox
              [(ngModel)]="detailSettings.taskOrder.requireSubtaskCompletion"
            >
              子タスク完了まで完了ステータスにできない
            </mat-checkbox>
          </div>
        </mat-expansion-panel>

        <!-- 作業時間記録 -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>作業時間記録</mat-panel-title>
          </mat-expansion-panel-header>
          <div class="setting-item">
            <label>予定時間</label>
            <div class="time-picker">
              <mat-form-field appearance="outline" class="time-field">
                <mat-label>時間</mat-label>
                <mat-select
                  [(ngModel)]="estimatedHours.hour"
                  (selectionChange)="onEstimatedTimeChange()"
                >
                  <mat-option *ngFor="let hour of hourOptions" [value]="hour.value">
                    {{ hour.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <span class="time-separator">:</span>
              <mat-form-field appearance="outline" class="time-field">
                <mat-label>分</mat-label>
                <mat-select
                  [(ngModel)]="estimatedHours.minute"
                  (selectionChange)="onEstimatedTimeChange()"
                >
                  <mat-option *ngFor="let minute of minuteOptions" [value]="minute.value">
                    {{ minute.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
          <div class="setting-item">
            <label>実績時間</label>
            <div class="time-picker">
              <mat-form-field appearance="outline" class="time-field">
                <mat-label>時間</mat-label>
                <mat-select
                  [(ngModel)]="actualHours.hour"
                  (selectionChange)="onActualTimeChange()"
                >
                  <mat-option *ngFor="let hour of hourOptions" [value]="hour.value">
                    {{ hour.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <span class="time-separator">:</span>
              <mat-form-field appearance="outline" class="time-field">
                <mat-label>分</mat-label>
                <mat-select
                  [(ngModel)]="actualHours.minute"
                  (selectionChange)="onActualTimeChange()"
                >
                  <mat-option *ngFor="let minute of minuteOptions" [value]="minute.value">
                    {{ minute.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        </mat-expansion-panel>
      </div>

      <div class="settings-actions">
        <button mat-button (click)="closeDetailSettings()">キャンセル</button>
        <button
          mat-raised-button
          color="primary"
          (click)="saveDetailSettings()"
        >
          保存
        </button>
      </div>
    </div>
  </div>
</div>

<!-- タスクが見つからない場合 -->
<ng-template #taskNotFound>
  <div class="task-not-found">
    <mat-card>
      <mat-card-content>
        <div class="not-found-content">
          <mat-icon class="error-icon">error_outline</mat-icon>
          <h2>タスクが見つかりません</h2>
          <p>指定されたタスクが存在しないか、アクセス権限がありません。</p>
          <button mat-button (click)="goBack()" color="primary">
            <mat-icon>arrow_back</mat-icon>
            戻る
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</ng-template>
