<div class="page-header">
  <button mat-button (click)="goBack()" class="back-button">
    <mat-icon>arrow_back</mat-icon>
    {{ "taskDetail.back" | translate }}
  </button>
  <h2>
    {{
      (task?.parentTaskId ? "taskDetail.childTaskTitle" : "taskDetail.title")
        | translate
    }}
  </h2>
</div>

<div
  *ngIf="task; else loading"
  class="task-card"
  [style.background]="projectThemeColor"
>
  <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
  <div class="task-toolbar">
    <div class="toolbar-spacer"></div>
    <div class="header-calendar-toggle">
      <button
        type="button"
        class="calendar-switch"
        [class.on]="isEditing"
        [disabled]="isSaving || (isEditing && !canSaveTask())"
        (click)="toggleEdit()"
        role="switch"
        [attr.aria-checked]="isEditing"
      >
        <span class="calendar-switch-handle"></span>
      </button>
      <span class="calendar-switch-label">
        {{ "taskDetail.editMode" | translate }}
        {{
          isEditing
            ? ("taskDetail.on" | translate)
            : ("taskDetail.off" | translate)
        }}
      </span>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="task-main-content" *ngIf="!isLoading && task">
    <!-- ã‚¿ã‚¹ã‚¯åãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="task-header-section">
      <h1 class="task-title" *ngIf="!isEditing">
        {{ taskData.taskName || ("taskDetail.title" | translate) }}
      </h1>
      <mat-form-field
        *ngIf="isEditing"
        appearance="outline"
        class="full-width-field task-name-edit-field"
      >
        <input
          matInput
          [(ngModel)]="taskData.taskName"
          name="taskName"
          [placeholder]="
            task.parentTaskId
              ? ('taskDetail.childTaskNamePlaceholderFull' | translate)
              : ('taskDetail.taskNamePlaceholderFull' | translate)
          "
          maxlength="30"
          required
        />
        <mat-hint align="end"
          >{{ (taskData.taskName || "").length }}/30</mat-hint
        >
      </mat-form-field>
    </div>

    <!-- åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="task-info-section">
      <ng-container *ngIf="!isEditing; else taskEditForm">
        <!-- èª­ã¿å–ã‚Šãƒ¢ãƒ¼ãƒ‰ -->
        <p>
          <strong>{{ "taskDetail.project" | translate }}:</strong>
          {{ taskData.projectName || project?.projectName || "â€”" }}
        </p>

        <p *ngIf="parentTaskName && task?.parentTaskId">
          <strong>{{ "taskDetail.parentTask" | translate }}:</strong>
          {{ parentTaskName }}
        </p>

        <p>
          <strong>{{ "taskDetail.description" | translate }}:</strong>
          {{ taskData.description || ("taskDetail.noDescription" | translate) }}
        </p>

        <p>
          <strong>{{ "taskDetail.period" | translate }}:</strong>
          {{ formatDateForDisplay(taskData.startDate) }}
          {{ "taskDetail.periodSeparator" | translate }}
          {{ formatDateForDisplay(taskData.dueDate) }}
        </p>

        <p>
          <strong>{{ "taskDetail.assignee" | translate }}:</strong>
          <span
            *ngIf="
              taskData.assignedMembers && taskData.assignedMembers.length > 0
            "
          >
            {{ getAssignedMembersDisplay() }}
          </span>
          <span
            *ngIf="
              !taskData.assignedMembers || taskData.assignedMembers.length === 0
            "
          >
            {{ getCurrentMemberNameByName(taskData.assignee) || "â€”" }}
          </span>
        </p>

        <p>
          <strong>{{ "taskDetail.status" | translate }}:</strong>
          {{ getStatusDisplay(taskData.status) }}
        </p>

        <p>
          <strong>{{ "taskDetail.priority" | translate }}:</strong>
          {{ getPriorityDisplay(taskData.priority) }}
        </p>

        <!-- è³‡æ–™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆèª­ã¿å–ã‚Šãƒ¢ãƒ¼ãƒ‰ï¼‰-->
        <p>
          <strong>ğŸ“ {{ "taskDetail.materials" | translate }}:</strong>
        </p>
        <div
          class="materials-container"
          *ngIf="
            (editableAttachments && editableAttachments.length > 0) ||
              (taskData.urls && taskData.urls.length > 0);
            else noMaterials
          "
        >
          <div class="materials-list">
            <!-- æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ« -->
            <div
              class="material-item"
              *ngFor="let attachment of editableAttachments"
            >
              <span class="material-icon">ğŸ“</span>
              <a
                [href]="attachment.url"
                target="_blank"
                rel="noopener noreferrer"
                class="material-link"
              >
                {{ attachment.name }}
              </a>
              <span
                class="material-size"
                *ngIf="attachment.type === 'file' && attachment.size"
              >
                ({{ formatFileSize(attachment.size) }})
              </span>
            </div>
            <!-- URLãƒªãƒ³ã‚¯ -->
            <div class="material-item" *ngFor="let url of taskData.urls || []">
              <span class="material-icon">ğŸ”—</span>
              <a
                [href]="url"
                target="_blank"
                rel="noopener noreferrer"
                class="material-link"
              >
                {{ extractUrlLabel(url) }}
              </a>
            </div>
          </div>
        </div>
        <ng-template #noMaterials>
          <span class="no-materials">{{
            "taskDetail.noMaterials" | translate
          }}</span>
        </ng-template>

        <!-- ã‚¿ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆèª­ã¿å–ã‚Šãƒ¢ãƒ¼ãƒ‰ï¼‰-->
        <p>
          <strong>{{ "taskDetail.tags" | translate }}:</strong>
          <mat-chip-set *ngIf="taskData.tags && taskData.tags.length > 0">
            <mat-chip *ngFor="let tag of taskData.tags || []">
              {{ tag }}
            </mat-chip>
          </mat-chip-set>
          <span *ngIf="!taskData.tags || taskData.tags.length === 0">{{
            "taskDetail.noTags" | translate
          }}</span>
        </p>
      </ng-container>

      <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ -->
      <ng-template #taskEditForm>
        <form class="task-inline-edit-form" novalidate>
          <mat-form-field appearance="outline" class="full-width-field">
            <mat-label>{{ "taskDetail.projectName" | translate }}</mat-label>
            <input
              matInput
              [value]="taskData.projectName || project?.projectName || ''"
              disabled
            />
          </mat-form-field>

          <mat-form-field
            *ngIf="parentTaskName && task?.parentTaskId"
            appearance="outline"
            class="full-width-field"
          >
            <mat-label>{{ "taskDetail.parentTaskName" | translate }}</mat-label>
            <input matInput [value]="parentTaskName" disabled />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width-field">
            <textarea
              matInput
              rows="3"
              [(ngModel)]="taskData.description"
              name="description"
              [placeholder]="'taskDetail.descriptionPlaceholder' | translate"
              maxlength="200"
            ></textarea>
            <mat-hint align="end"
              >{{ (taskData.description || "").length }}/200</mat-hint
            >
          </mat-form-field>

          <div class="inline-date-row">
            <mat-form-field appearance="outline" class="date-field">
              <input
                matInput
                [matDatepicker]="taskStartDatePicker"
                [(ngModel)]="taskStartDateObj"
                (dateChange)="onTaskStartDateChange()"
                [max]="taskDueDateObj || maxDate"
                [ngModelOptions]="{ standalone: true }"
                [placeholder]="
                  'taskDetail.startDatePlaceholderFull' | translate
                "
                (click)="taskStartDatePicker.open()"
                (keydown)="$event.preventDefault()"
                required
              />
              <mat-datepicker-toggle
                matIconSuffix
                [for]="taskStartDatePicker"
              ></mat-datepicker-toggle>
              <mat-datepicker #taskStartDatePicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="date-field">
              <input
                matInput
                [matDatepicker]="taskDueDatePicker"
                [(ngModel)]="taskDueDateObj"
                (dateChange)="onTaskDueDateChange()"
                [min]="taskStartDateObj || undefined"
                [max]="maxDate"
                [ngModelOptions]="{ standalone: true }"
                [placeholder]="'taskDetail.dueDatePlaceholderFull' | translate"
                (click)="taskDueDatePicker.open()"
                (keydown)="$event.preventDefault()"
                required
              />
              <mat-datepicker-toggle
                matIconSuffix
                [for]="taskDueDatePicker"
              ></mat-datepicker-toggle>
              <mat-datepicker #taskDueDatePicker></mat-datepicker>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width-field">
            <mat-select
              [(ngModel)]="selectedAssignedMemberIds"
              name="assignedMembers"
              multiple
              (ngModelChange)="onAssignedMembersChange($event)"
              [disabled]="membersLoading"
              [placeholder]="'taskDetail.assigneePlaceholderFull' | translate"
              required
            >
              <mat-option
                *ngFor="let member of projectMembers"
                [value]="member.id"
              >
                {{ member.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div
            class="selected-members-chips"
            *ngIf="selectedAssignedMemberIds.length > 0"
          >
            <mat-chip-set>
              <mat-chip
                *ngFor="let memberId of selectedAssignedMemberIds"
                selected
              >
                {{ getMemberNameById(memberId) }}
              </mat-chip>
            </mat-chip-set>
          </div>

          <mat-form-field appearance="outline" class="full-width-field">
            <mat-select
              [(ngModel)]="taskData.status"
              name="status"
              [placeholder]="'taskDetail.status' | translate"
            >
              <mat-option value="æœªç€æ‰‹">{{
                "taskDetail.status.notStarted" | translate
              }}</mat-option>
              <mat-option value="ä½œæ¥­ä¸­">{{
                "taskDetail.status.inProgress" | translate
              }}</mat-option>
              <mat-option value="å®Œäº†">{{
                "taskDetail.status.completed" | translate
              }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width-field">
            <mat-select
              [(ngModel)]="taskData.priority"
              name="priority"
              [placeholder]="'taskDetail.priority' | translate"
            >
              <mat-option value="é«˜">{{
                "taskDetail.priority.high" | translate
              }}</mat-option>
              <mat-option value="ä¸­">{{
                "taskDetail.priority.medium" | translate
              }}</mat-option>
              <mat-option value="ä½">{{
                "taskDetail.priority.low" | translate
              }}</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®è³‡æ–™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="materials-edit-section">
            <label
              ><strong>{{ "taskDetail.materials" | translate }}</strong></label
            >
            <div class="materials-action-row">
              <button
                mat-stroked-button
                type="button"
                (click)="fileInput.click()"
                [disabled]="isUploading"
              >
                {{ "taskDetail.addFile" | translate }}
              </button>
              <input
                #fileInput
                type="file"
                multiple
                [accept]="fileAccept"
                (change)="onFilesSelected($event)"
                hidden
              />
              <mat-form-field appearance="outline" class="url-input-field">
                <input
                  matInput
                  [(ngModel)]="newUrlInput"
                  [placeholder]="'taskDetail.urlPlaceholder' | translate"
                  (keyup.enter)="addUrl(newUrlInput)"
                  name="newUrl"
                />
              </mat-form-field>
              <button
                mat-stroked-button
                type="button"
                (click)="addUrl(newUrlInput)"
              >
                {{ "taskDetail.add" | translate }}
              </button>
            </div>

            <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º -->
            <div class="pending-files" *ngIf="pendingFiles.length > 0">
              <p>{{ "taskDetail.uploadingFiles" | translate }}:</p>
              <div class="pending-files-list">
                <div
                  class="pending-file-item"
                  *ngFor="let pending of pendingFiles"
                >
                  <mat-icon class="pending-icon">file_upload</mat-icon>
                  <span class="pending-filename">{{ pending.file.name }}</span>
                </div>
              </div>
            </div>

            <div
              class="materials-container"
              *ngIf="
                (editableAttachments && editableAttachments.length > 0) ||
                (taskData.urls && taskData.urls.length > 0)
              "
            >
              <div class="materials-list">
                <!-- æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ« -->
                <div
                  class="material-item edit-mode"
                  *ngFor="let attachment of editableAttachments"
                >
                  <span class="material-icon">ğŸ“</span>
                  <a
                    [href]="attachment.url"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="material-link"
                  >
                    {{ attachment.name }}
                  </a>
                  <span
                    class="material-size"
                    *ngIf="attachment.type === 'file' && attachment.size"
                  >
                    ({{ formatFileSize(attachment.size) }})
                  </span>
                  <button
                    mat-icon-button
                    type="button"
                    (click)="removeAttachment(attachment)"
                    class="material-remove"
                  >
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
                <!-- URLãƒªãƒ³ã‚¯ -->
                <div
                  class="material-item edit-mode"
                  *ngFor="let url of taskData.urls || []"
                >
                  <span class="material-icon">ğŸ”—</span>
                  <a
                    [href]="url"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="material-link"
                  >
                    {{ extractUrlLabel(url) }}
                  </a>
                  <button
                    mat-icon-button
                    type="button"
                    (click)="removeUrl(url)"
                    class="material-remove"
                  >
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¿ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="tag-editor-simple">
            <p>
              <strong>{{ "taskDetail.tags" | translate }}:</strong>
              <mat-chip-set>
                <mat-chip
                  *ngFor="let tag of taskData.tags || []"
                  removable
                  (removed)="removeTag(tag)"
                >
                  {{ tag }}
                  <mat-icon matChipRemove>close</mat-icon>
                </mat-chip>
              </mat-chip-set>
              <mat-form-field appearance="outline" class="tag-input-field">
                <input
                  matInput
                  #tagInput
                  [placeholder]="
                    ('taskDetail.enterTag' | translate) +
                    ' ' +
                    ('taskDetail.tagPlaceholder' | translate)
                  "
                  (keyup.enter)="addTag(tagInput.value); tagInput.value = ''"
                  maxlength="20"
                />
                <mat-hint align="end"
                  >{{ tagInput.value?.length || 0 }}/20</mat-hint
                >
              </mat-form-field>
            </p>
          </div>
        </form>
      </ng-template>
    </div>

    <!-- å¤ã„ã‚¿ã‚°ã¨é–¢é€£è³‡æ–™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ -->
    <div class="task-tags-section" style="display: none">
      <ng-container *ngIf="!isEditing; else editTagsForm">
        <!-- èª­ã¿å–ã‚Šãƒ¢ãƒ¼ãƒ‰ -->
        <p>
          <strong>{{ "taskDetail.tags" | translate }}:</strong>
          <mat-chip-set *ngIf="taskData.tags && taskData.tags.length > 0">
            <mat-chip *ngFor="let tag of taskData.tags || []">
              {{ tag }}
            </mat-chip>
          </mat-chip-set>
          <span *ngIf="!taskData.tags || taskData.tags.length === 0">{{
            "taskDetail.noTags" | translate
          }}</span>
        </p>

        <p>
          <strong>{{ "taskDetail.relatedFiles" | translate }}:</strong>
          <mat-chip-set
            *ngIf="taskData.relatedFiles && taskData.relatedFiles.length > 0"
          >
            <mat-chip *ngFor="let file of taskData.relatedFiles || []">
              <mat-icon>{{ isUrl(file) ? "link" : "attach_file" }}</mat-icon>
              <a
                *ngIf="isUrl(file)"
                class="file-link"
                (click)="openUrl(file)"
                >{{ file }}</a
              >
              <span *ngIf="!isUrl(file)">{{ file }}</span>
            </mat-chip>
          </mat-chip-set>
          <span
            *ngIf="!taskData.relatedFiles || taskData.relatedFiles.length === 0"
            >{{ "taskDetail.noRelatedFiles" | translate }}</span
          >
        </p>
      </ng-container>

      <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ -->
      <ng-template #editTagsForm>
        <div class="tag-editor">
          <p>
            <strong>{{ "taskDetail.tags" | translate }}:</strong>
            <mat-chip-set>
              <mat-chip
                *ngFor="let tag of taskData.tags || []"
                removable
                (removed)="removeTag(tag)"
              >
                {{ tag }}
                <mat-icon matChipRemove>close</mat-icon>
              </mat-chip>
            </mat-chip-set>
            <mat-form-field appearance="outline" class="tag-input-field">
              <input
                matInput
                #tagInput
                [placeholder]="'taskDetail.enterTag' | translate"
                (keyup.enter)="addTag(tagInput.value); tagInput.value = ''"
              />
            </mat-form-field>
          </p>

          <p>
            <strong>{{ "taskDetail.relatedFiles" | translate }}:</strong>
            <mat-chip-set>
              <mat-chip
                *ngFor="let file of taskData.relatedFiles || []"
                removable
                (removed)="removeRelatedFile(file)"
              >
                <mat-icon>{{ isUrl(file) ? "link" : "attach_file" }}</mat-icon>
                <a
                  *ngIf="isUrl(file)"
                  class="file-link"
                  (click)="openUrl(file)"
                  >{{ file }}</a
                >
                <span *ngIf="!isUrl(file)">{{ file }}</span>
                <mat-icon matChipRemove>close</mat-icon>
              </mat-chip>
            </mat-chip-set>
            <mat-form-field appearance="outline" class="tag-input-field">
              <input
                matInput
                #fileInput
                [placeholder]="
                  'taskDetail.enterUrlOrFileNamePlaceholder' | translate
                "
                (keyup.enter)="
                  addRelatedFile(fileInput.value); fileInput.value = ''
                "
              />
            </mat-form-field>
          </p>
        </div>
      </ng-template>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="task-chat-section">
      <h3>{{ "taskDetail.taskChat" | translate }}</h3>
      <app-project-chat
        *ngIf="task?.id"
        [projectId]="task.id!"
        [chatTitle]="'taskDetail.taskChat' | translate"
      >
      </app-project-chat>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="task-actions-section">
      <div class="action-buttons-container">
        <div class="action-buttons-left" *ngIf="!isEditing">
          <button
            mat-raised-button
            (click)="createSubtask()"
            *ngIf="!task?.parentTaskId"
          >
            <mat-icon>add</mat-icon>
            {{ "taskDetail.createSubtask" | translate }}
          </button>
          <button mat-raised-button (click)="duplicateTask()">
            <mat-icon>content_copy</mat-icon>
            {{ "taskDetail.duplicate" | translate }}
          </button>
          <div class="detail-settings-group">
            <button mat-raised-button (click)="openDetailSettings()">
              <mat-icon>settings</mat-icon>
              {{ "taskDetail.detailSettings" | translate }}
            </button>
            <div class="header-calendar-toggle">
              <button
                type="button"
                class="calendar-switch"
                [class.on]="taskData.calendarSyncEnabled"
                [disabled]="isCalendarSyncSaving"
                (click)="toggleCalendarSync()"
                role="switch"
                [attr.aria-checked]="taskData.calendarSyncEnabled"
              >
                <span class="calendar-switch-handle"></span>
              </button>
              <span class="calendar-switch-label">
                {{ "taskDetail.calendarSync" | translate }}
                {{
                  taskData.calendarSyncEnabled
                    ? ("taskDetail.on" | translate)
                    : ("taskDetail.off" | translate)
                }}
              </span>
            </div>
          </div>
        </div>
        <div class="action-buttons-right" *ngIf="isEditing">
          <button
            mat-raised-button
            color="warn"
            class="delete-button-styled"
            (click)="deleteTask()"
          >
            <mat-icon>delete</mat-icon>
            {{ "taskDetail.deleteTask" | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- å­ã‚¿ã‚¹ã‚¯ä¸€è¦§ -->
    <div
      *ngIf="childTasks.length > 0"
      class="child-tasks-section"
      [style.background]="getChildTasksSectionBackground()"
    >
      <div class="child-tasks-header">
        <h3>{{ "taskDetail.childTasks" | translate }}</h3>
        <div class="child-tasks-actions">
          <button
            mat-raised-button
            color="accent"
            (click)="exportChildTasksToCSV()"
          >
            <mat-icon>download</mat-icon>
            {{ "taskDetail.export" | translate }}
          </button>
        </div>
      </div>

      <div class="child-filter-section">
        <mat-form-field appearance="outline">
          <mat-label>{{ "taskDetail.status" | translate }}</mat-label>
          <mat-select
            [(ngModel)]="childFilterStatus"
            (selectionChange)="applyChildFilter()"
            [placeholder]="'taskDetail.status' | translate"
          >
            <mat-option value="">{{ "taskDetail.all" | translate }}</mat-option>
            <mat-option *ngFor="let status of statusOptions" [value]="status">
              {{ getStatusDisplay(status) }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ "taskDetail.priority" | translate }}</mat-label>
          <mat-select
            [(ngModel)]="childFilterPriority"
            (selectionChange)="applyChildFilter()"
            [placeholder]="'taskDetail.priority' | translate"
          >
            <mat-option value="">{{ "taskDetail.all" | translate }}</mat-option>
            <mat-option
              *ngFor="let priority of priorityOptions"
              [value]="priority"
            >
              {{ getPriorityDisplay(priority) }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ "taskDetail.assignee" | translate }}</mat-label>
          <mat-select
            [(ngModel)]="childFilterAssignee"
            (selectionChange)="applyChildFilter()"
            [placeholder]="'taskDetail.assignee' | translate"
          >
            <mat-option value="">{{ "taskDetail.all" | translate }}</mat-option>
            <mat-option
              *ngFor="let assignee of childAssigneeOptions"
              [value]="assignee"
            >
              {{ assignee }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="due-date-filter-field">
          <input
            matInput
            [matDatepicker]="childDueDatePicker"
            [(ngModel)]="childFilterDueDateObj"
            (dateChange)="onChildDueDateChange()"
            [max]="maxDate"
            [ngModelOptions]="{ standalone: true }"
            [placeholder]="'taskDetail.selectDueDate' | translate"
            (click)="childDueDatePicker.open()"
            (keydown)="$event.preventDefault()"
          />
          <mat-datepicker-toggle
            matIconSuffix
            [for]="childDueDatePicker"
          ></mat-datepicker-toggle>
          <mat-datepicker #childDueDatePicker></mat-datepicker>
        </mat-form-field>

        <button mat-stroked-button (click)="resetChildFilter()">
          <mat-icon>refresh</mat-icon>
          {{ "taskDetail.reset" | translate }}
        </button>
      </div>

      <div
        class="child-tasks-grid"
        *ngIf="filteredChildTasks.length > 0; else noChildTasks"
      >
        <mat-card
          *ngFor="let child of filteredChildTasks"
          class="child-task-card"
          [ngClass]="{ completed: child.status === 'å®Œäº†' }"
          (click)="openChildTaskDetail(child)"
        >
          <mat-card-header class="child-task-card-header">
            <mat-card-title>
              <span class="child-task-card-title-text">{{
                child.taskName
              }}</span>
            </mat-card-title>
            <div class="child-task-card-meta">
              <mat-chip-set>
                <mat-chip
                  class="child-status-chip"
                  [ngClass]="'status-' + child.status"
                  selected
                >
                  {{ getStatusDisplay(child.status, true) }}
                </mat-chip>
                <mat-chip
                  class="child-priority-chip"
                  [ngClass]="'priority-' + child.priority"
                  selected
                >
                  {{ getPriorityDisplay(child.priority, true) }}
                </mat-chip>
              </mat-chip-set>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="child-task-details">
              <div class="child-task-main-info">
                <div class="child-task-detail-item child-task-detail-member">
                  <mat-icon>person</mat-icon>
                  <span class="child-task-member-name">{{
                    getChildTaskAssigneeDisplay(child) ||
                      ("taskDetail.unassigned" | translate)
                  }}</span>
                  <div class="child-task-member-due">
                    <mat-icon>schedule</mat-icon>
                    <span>{{
                      child.dueDate || ("taskDetail.notSet" | translate)
                    }}</span>
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <ng-template #noChildTasks>
        <div class="child-no-tasks">
          <mat-icon>inbox</mat-icon>
          <p>{{ "taskDetail.noChildTasks" | translate }}</p>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- è©³ç´°è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <div
    class="detail-settings-overlay"
    *ngIf="isDetailSettingsOpen"
    (click)="closeDetailSettings()"
  >
    <div class="detail-settings-dialog" (click)="$event.stopPropagation()">
      <div class="settings-header">
        <h2>{{ "taskDetail.detailSettings" | translate }}</h2>
        <button mat-icon-button (click)="closeDetailSettings()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="settings-content">
        <!-- é€šçŸ¥è¨­å®š -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>{{
              "taskDetail.notificationSettings" | translate
            }}</mat-panel-title>
          </mat-expansion-panel-header>
          <div class="setting-item notification-toggle">
            <span class="calendar-toggle-label">{{
              "taskDetail.taskDeadlineNotification" | translate
            }}</span>
            <button
              type="button"
              class="calendar-switch"
              [class.on]="detailSettings.notifications.beforeDeadline"
              (click)="toggleTaskDeadlineNotification()"
              role="switch"
              [attr.aria-checked]="detailSettings.notifications.beforeDeadline"
            >
              <span class="calendar-switch-handle"></span>
            </button>
            <span
              class="calendar-toggle-state"
              [class.on]="detailSettings.notifications.beforeDeadline"
            >
              {{
                detailSettings.notifications.beforeDeadline
                  ? ("taskDetail.on" | translate)
                  : ("taskDetail.off" | translate)
              }}
            </span>
          </div>
        </mat-expansion-panel>

        <!-- ã‚¿ã‚¹ã‚¯ã®é †ç•ªç®¡ç†ï¼ˆè¦ªã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤ºï¼‰ -->
        <mat-expansion-panel *ngIf="!task?.parentTaskId">
          <mat-expansion-panel-header>
            <mat-panel-title>{{
              "taskDetail.taskOrder" | translate
            }}</mat-panel-title>
          </mat-expansion-panel-header>
          <div class="setting-item">
            <mat-checkbox
              [(ngModel)]="detailSettings.taskOrder.requireSubtaskCompletion"
            >
              {{ "taskDetail.cannotCompleteUntilSubtasksDone" | translate }}
            </mat-checkbox>
          </div>
        </mat-expansion-panel>

        <!-- ä½œæ¥­æ™‚é–“è¨˜éŒ² -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>{{
              "taskDetail.timeTracking" | translate
            }}</mat-panel-title>
          </mat-expansion-panel-header>
          <div class="setting-item">
            <div class="time-picker">
              <mat-form-field appearance="outline" class="time-field">
                <mat-select
                  [(ngModel)]="estimatedHours.hour"
                  (selectionChange)="onEstimatedTimeChange()"
                  [placeholder]="'taskDetail.hour' | translate"
                >
                  <mat-option
                    *ngFor="let hour of hourOptions"
                    [value]="hour.value"
                  >
                    {{ hour.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <span class="time-separator">:</span>
              <mat-form-field appearance="outline" class="time-field">
                <mat-select
                  [(ngModel)]="estimatedHours.minute"
                  (selectionChange)="onEstimatedTimeChange()"
                  [placeholder]="'taskDetail.minute' | translate"
                >
                  <mat-option
                    *ngFor="let minute of minuteOptions"
                    [value]="minute.value"
                  >
                    {{ minute.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        </mat-expansion-panel>
      </div>

      <div class="settings-actions">
        <button mat-button (click)="closeDetailSettings()">
          {{ "taskDetail.cancel" | translate }}
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="saveDetailSettings()"
        >
          {{ "taskDetail.save" | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
<ng-template #loading>
  <div class="loading-container">
    <mat-spinner></mat-spinner>
    <p>{{ "taskDetail.loadingTaskInfo" | translate }}</p>
  </div>
</ng-template>
