<div class="task-form-dialog" [ngStyle]="getThemeBackgroundStyle()">
  <h2 mat-dialog-title>
    <mat-icon>add_task</mat-icon>
    タスクを追加
  </h2>

  <mat-dialog-content>
    <div class="form-fields">
      <!-- プロジェクト名（読み取り専用） -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>プロジェクト名</mat-label>
        <input matInput [value]="model.projectName || '—'" readonly />
        <mat-icon matSuffix>folder</mat-icon>
      </mat-form-field>

      <mat-form-field
        *ngIf="parentTaskName"
        appearance="outline"
        class="full-width"
      >
        <mat-label>親タスク</mat-label>
        <input matInput [value]="parentTaskName" readonly />
        <mat-icon matSuffix>subdirectory_arrow_right</mat-icon>
      </mat-form-field>

      <!-- タスク名 -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>タスク名 *</mat-label>
        <input
          matInput
          [(ngModel)]="model.taskName"
          placeholder="例: 要件定義書作成"
          required
          maxlength="50"
        />
        <mat-icon matSuffix>task</mat-icon>
      </mat-form-field>

      <!-- タグ -->
      <div class="tag-section">
        <mat-form-field appearance="outline" class="full-width tag-input-field">
          <mat-label>タグ</mat-label>
          <span matPrefix>#&nbsp;</span>
          <input
            matInput
            name="tagInput"
            [(ngModel)]="tagInputValue"
            [ngModelOptions]="{ standalone: true }"
            placeholder="タグ名を入力してEnter（20文字以内）"
            (keydown.enter)="onTagInputEnter($event)"
            maxlength="20"
          />
          <mat-hint align="end">{{ (tagInputValue || '').length }}/20</mat-hint>
        </mat-form-field>
        <div class="tag-list" *ngIf="model.tags?.length">
          <div *ngFor="let tag of model.tags" class="tag-chip">
            <span class="tag-chip-label">#{{ tag }}</span>
            <button
              type="button"
              class="tag-remove-button"
              (click)="removeTag(tag)"
              [attr.aria-label]="'#' + tag + ' を削除'"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <!-- ステータス -->
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>ステータス</mat-label>
        <mat-select [(ngModel)]="model.status">
          <mat-option value="未着手">未着手</mat-option>
          <mat-option value="作業中">作業中</mat-option>
          <mat-option value="完了">完了</mat-option>
        </mat-select>
        <mat-icon matSuffix>flag</mat-icon>
      </mat-form-field>

      <!-- 優先度 -->
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>優先度</mat-label>
        <mat-select [(ngModel)]="model.priority">
          <mat-option value="高">高</mat-option>
          <mat-option value="中">中</mat-option>
          <mat-option value="低">低</mat-option>
        </mat-select>
        <mat-icon matSuffix>priority_high</mat-icon>
      </mat-form-field>

      <!-- カレンダー連携 -->
      <div class="calendar-toggle-container">
        <span class="calendar-toggle-label">カレンダー連携</span>
        <button
          type="button"
          class="calendar-switch"
          [class.on]="model.calendarSyncEnabled"
          (click)="model.calendarSyncEnabled = !model.calendarSyncEnabled"
          role="switch"
          [attr.aria-checked]="model.calendarSyncEnabled"
        >
          <span class="calendar-switch-handle"></span>
        </button>
        <span
          class="calendar-toggle-state"
          [class.on]="model.calendarSyncEnabled"
        >
          {{ model.calendarSyncEnabled ? 'ON' : 'OFF' }}
        </span>
      </div>

      <!-- 担当者選択 -->
      <div class="assignee-selection">
        <div class="assignee-header">
          <h4>担当者</h4>
        </div>

        <!-- ローディング表示 -->
        <div *ngIf="loading" class="loading-assignee">
          <mat-spinner diameter="20"></mat-spinner>
          <span>メンバーを読み込み中...</span>
        </div>

        <!-- メンバー選択 -->
        <div *ngIf="!loading && projectMembers.length > 0">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>担当者を選択</mat-label>
            <mat-select
              [(ngModel)]="selectedMemberId"
              (selectionChange)="onMemberSelectionChange($event.value)"
              placeholder="担当者を選択してください"
            >
              <mat-option *ngFor="let member of projectMembers" [value]="member.id">
                {{ member.name }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>people</mat-icon>
          </mat-form-field>
        </div>

        <!-- メンバーがいない場合 -->
        <div *ngIf="!loading && projectMembers.length === 0" class="no-members">
          <mat-icon class="no-members-icon">people_outline</mat-icon>
          <p>プロジェクトにメンバーが登録されていません</p>
          <p>先にプロジェクト詳細画面でメンバーを登録してください。</p>
        </div>
      </div>

      <!-- 開始日・期限 -->
      <div class="date-fields">
        <div class="date-field">
          <label for="startDate">開始日</label>
          <div class="date-input-wrapper">
            <input
              id="startDate"
              type="date"
              [(ngModel)]="startDateString"
              placeholder="開始日を選択"
              class="date-input"
              max="9999-12-31"
            />
            <mat-icon class="date-icon">event</mat-icon>
          </div>
        </div>

        <div class="date-field">
          <label for="dueDate">期限</label>
          <div class="date-input-wrapper">
            <input
              id="dueDate"
              type="date"
              [(ngModel)]="dueDateString"
              [min]="startDateString || ''"
              placeholder="期限を選択"
              class="date-input"
              max="9999-12-31"
            />
            <mat-icon class="date-icon">event</mat-icon>
          </div>
        </div>
      </div>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="cancel()">キャンセル</button>
    <button
      mat-raised-button
      color="primary"
      (click)="save()"
      [disabled]="!model.taskName"
    >
      <mat-icon>save</mat-icon>
      保存
    </button>
  </mat-dialog-actions>
</div>
