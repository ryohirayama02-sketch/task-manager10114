<h2>ガントチャート式課題管理</h2>

<!-- プロジェクト選択とフィルター -->
<div class="controls-section" style="justify-content: space-between; align-items: flex-start;">
  <div class="project-selector">
    <h3>表示するプロジェクトを選択</h3>
    <div class="project-checkboxes">
      <mat-checkbox
        *ngFor="let project of projects"
        [checked]="project.id ? isProjectSelected(project.id) : false"
        (change)="project.id ? toggleProjectSelection(project.id) : null"
        class="project-checkbox"
      >
        {{ project.projectName }}
      </mat-checkbox>
    </div>
    <div class="project-selection-actions">
      <button mat-stroked-button (click)="selectAllProjects()">
        すべてにチェック
      </button>
      <button mat-stroked-button (click)="clearProjectSelection()">
        すべてのチェックをクリア
      </button>
      <button
        mat-raised-button
        color="primary"
        class="create-project-button"
        (click)="openProjectDialog()"
      >
        + プロジェクトを作成
      </button>
    </div>
  </div>

  <!-- フィルター -->
  <div class="filter-section">
    <mat-form-field appearance="outline">
      <mat-label>ステータス</mat-label>
      <mat-select [(ngModel)]="filterStatus" (selectionChange)="applyFilters()" multiple>
        <mat-option value="未着手">未着手</mat-option>
        <mat-option value="作業中">作業中</mat-option>
        <mat-option value="完了">完了</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>優先度</mat-label>
      <mat-select
        [(ngModel)]="filterPriority"
        (selectionChange)="applyFilters()"
        multiple
      >
        <mat-option value="高">高</mat-option>
        <mat-option value="中">中</mat-option>
        <mat-option value="低">低</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>担当者</mat-label>
      <mat-select
        [(ngModel)]="filterAssignee"
        (selectionChange)="applyFilters()"
        multiple
      >
        <mat-option
          *ngFor="let assignee of getUniqueAssignees()"
          [value]="assignee"
        >
          {{ assignee }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-button (click)="resetFilters()">フィルターリセット</button>
  </div>
</div>

<!-- ガントチャート -->
<div class="gantt-container">
  <!-- 凡例 -->
  <div class="legend">
    <h4>ステータス</h4>
    <div class="legend-items">
      <div class="legend-item status-not-started">
        <div
          class="legend-color"
          [style.background-color]="statusColors['未着手']"
        ></div>
        <span>未着手</span>
      </div>
      <div class="legend-item status-in-progress">
        <div
          class="legend-color"
          [style.background-color]="statusColors['作業中']"
        ></div>
        <span>作業中</span>
      </div>
      <div class="legend-item status-completed">
        <div
          class="legend-color"
          [style.background-color]="statusColors['完了']"
        ></div>
        <span>完了</span>
      </div>
    </div>
  </div>

  <!-- ガントチャート本体 -->
  <div class="gantt-chart">
    <!-- 左ペイン（固定カラム） -->
    <div class="gantt-left-pane">
      <!-- 左ヘッダー -->
      <div class="gantt-header-left" #leftHeader>
        <div class="header-cell">プロジェクト名</div>
        <div class="header-cell">タスク名</div>
        <div class="header-cell">優先度</div>
        <div
          class="header-cell"
          [style.width.px]="assigneeColumnWidth"
          [style.min-width.px]="assigneeColumnWidth"
          [style.max-width.px]="assigneeColumnWidth"
          style="white-space: nowrap"
        >
          担当者
        </div>
      </div>
      <!-- 左ボディ -->
      <div class="gantt-body-left" #leftPane (scroll)="onLeftScroll()">
        <div *ngFor="let task of tasks" class="task-row">
          <div
            class="task-info"
            [style.width.px]="totalInfoWidth"
            [style.min-width.px]="totalInfoWidth"
            [style.max-width.px]="totalInfoWidth"
          >
            <div
              class="info-cell project-name clickable"
              [ngStyle]="getProjectNameStyle(task)"
              (click)="openProjectDetail(task.projectId)"
              [appTruncateOverflow]="task.projectName"
            ></div>
            <div
              class="info-cell task-name clickable"
              (click)="openTaskDetail(task)"
              [appTruncateOverflow]="task.taskName"
            ></div>
            <div
              class="info-cell priority"
              [ngClass]="'priority-' + task.priority"
            >
              {{ task.priority }}
            </div>
            <div
              class="info-cell assignee"
              [style.width.px]="assigneeColumnWidth"
              [style.min-width.px]="assigneeColumnWidth"
              [style.max-width.px]="assigneeColumnWidth"
              [appTruncateOverflow]="task.assignee"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 右ペイン（タイムライン） -->
    <div class="gantt-right-pane">
      <!-- 右ヘッダー -->
      <div class="gantt-header-right" #rightHeader>
        <!-- 年月ラベル行 -->
        <div class="year-month-labels-row">
          <div
            *ngFor="let group of getGroupedDates()"
            class="year-month-label"
            [style.width.px]="getYearMonthLabelWidth(group)"
          >
            {{ formatYearMonth(group.dates[0]) }}
          </div>
        </div>
        <!-- 日付セル行 -->
        <div class="date-cells-row">
          <div *ngFor="let date of dateRange" class="date-cell">
            {{ formatDay(date) }}
            <!-- マイルストーン表示 -->
            <ng-container *ngIf="getMilestonesForDate(date) as milestones">
              <div
                *ngIf="milestones.length > 0"
                class="milestone-flag"
                (mouseenter)="showMilestoneTooltip($event, milestones)"
                (mouseleave)="hideMilestoneTooltip()"
              >
                🚩
              </div>
            </ng-container>
          </div>
        </div>
      </div>
      <!-- 右ボディ -->
      <div class="gantt-body-right" #rightPane (scroll)="onRightScroll()">
        <div class="gantt-bars" [style.height.px]="getGanttBarsHeight()">
          <!-- 年月ラベル行のスペース -->
          <div class="year-month-labels-spacer-row">
            <div
              *ngFor="let group of getGroupedDates()"
              class="year-month-label-spacer"
              [style.width.px]="getYearMonthLabelWidth(group)"
            ></div>
          </div>
          <!-- 背景の日付セル -->
          <div
            class="date-cells-background"
            [style.height.px]="getGanttBarsHeight()"
          >
            <div *ngFor="let date of dateRange" class="date-cell">
              <!-- 日付セル -->
            </div>
          </div>
          <!-- タスク行の区切り線 -->
          <div
            class="task-row-lines"
            [style.height.px]="getGanttBarsHeight()"
          >
            <div
              class="task-row-divider"
              [style.top.px]="getTaskHeaderDividerPosition()"
            ></div>
            <div
              *ngFor="let task of tasks; let i = index"
              class="task-row-divider"
              [style.top.px]="getTaskRowLinePosition(i)"
            ></div>
          </div>
          <!-- タスク期間バー -->
          <ng-container *ngFor="let task of tasks; let i = index">
            <div
              *ngIf="task.startDate && task.dueDate"
              class="task-bar clickable"
              [style.background-color]="getTaskBarBackground(task)"
              [style.left]="getTaskBarStartPosition(task) + 'px'"
              [style.width]="getTaskBarWidth(task) + 'px'"
              [style.top]="i * 40 + 4 + 'px'"
              [title]="
                task.taskName +
                ' (' +
                task.status +
                ') - ' +
                task.startDate +
                ' ～ ' +
                task.dueDate
              "
              (click)="openTaskDetail(task)"
            >
              <span
                class="task-bar-text"
                [style.color]="getTaskBarTextColor(task)"
              >
                {{ task.taskName }}
              </span>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- カスタムツールチップ -->
<div
  *ngIf="tooltipVisible"
  class="milestone-tooltip"
  [style.left.px]="tooltipPosition.x"
  [style.top.px]="tooltipPosition.y"
>
  <div class="tooltip-header">
    <span class="tooltip-icon">🚩</span>
    <span class="tooltip-title">マイルストーン</span>
  </div>
  <div class="tooltip-content">
    <div
      *ngFor="let milestone of tooltipMilestones"
      class="tooltip-item"
    >
      <div class="tooltip-project">{{ milestone.projectName }}</div>
      <div class="tooltip-name">{{ milestone.name }}</div>
      <div class="tooltip-date">
        {{ milestone.date | date : "yyyy/MM/dd" }}
      </div>
    </div>
  </div>
  <div class="tooltip-arrow"></div>
</div>
