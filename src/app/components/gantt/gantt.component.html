<h2>{{ 'gantt.title' | translate }}</h2>

<!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<div class="controls-section" style="justify-content: space-between; align-items: flex-start;">
  <div class="project-selector">
    <h3>{{ 'gantt.projectSelector.title' | translate }}</h3>
    <div class="project-checkboxes">
      <mat-checkbox
        *ngFor="let project of projects"
        [checked]="project.id ? isProjectSelected(project.id) : false"
        (change)="project.id ? toggleProjectSelection(project.id) : null"
        class="project-checkbox"
      >
        {{ project.projectName }}
      </mat-checkbox>
    </div>
    <div class="project-selection-actions">
      <div class="project-action-row">
        <button mat-stroked-button (click)="selectAllProjects()">
          {{ 'gantt.projectSelector.selectAll' | translate }}
        </button>
        <button mat-stroked-button (click)="clearProjectSelection()">
          {{ 'gantt.projectSelector.clearAll' | translate }}
        </button>
      </div>
      <button
        mat-stroked-button
        class="create-project-button"
        (click)="openProjectDialog()"
      >
        {{ 'gantt.projectSelector.createProject' | translate }}
      </button>
    </div>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="filter-section">
    <mat-form-field appearance="outline">
      <mat-label>{{ 'gantt.filter.status' | translate }}</mat-label>
      <mat-select [(ngModel)]="filterStatus" (selectionChange)="applyFilters()" multiple>
        <mat-option value="æœªç€æ‰‹">æœªç€æ‰‹</mat-option>
        <mat-option value="ä½œæ¥­ä¸­">ä½œæ¥­ä¸­</mat-option>
        <mat-option value="å®Œäº†">å®Œäº†</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>{{ 'gantt.filter.priority' | translate }}</mat-label>
      <mat-select
        [(ngModel)]="filterPriority"
        (selectionChange)="applyFilters()"
        multiple
      >
        <mat-option value="é«˜">é«˜</mat-option>
        <mat-option value="ä¸­">ä¸­</mat-option>
        <mat-option value="ä½">ä½</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>{{ 'gantt.filter.assignee' | translate }}</mat-label>
      <mat-select
        [(ngModel)]="filterAssignee"
        (selectionChange)="applyFilters()"
        multiple
      >
        <mat-option
          *ngFor="let assignee of getUniqueAssignees()"
          [value]="assignee"
        >
          {{ assignee }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-button (click)="resetFilters()">{{ 'gantt.filter.reset' | translate }}</button>
  </div>
</div>

<!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ -->
<div class="gantt-container">
  <!-- å‡¡ä¾‹ -->
  <div class="legend">
    <h4>{{ 'gantt.legend.status' | translate }}</h4>
    <div class="legend-items">
      <div class="legend-item status-not-started">
        <div
          class="legend-color"
          [style.background-color]="statusColors['æœªç€æ‰‹']"
        ></div>
        <span>{{ 'gantt.legend.notStarted' | translate }}</span>
      </div>
      <div class="legend-item status-in-progress">
        <div
          class="legend-color"
          [style.background-color]="statusColors['ä½œæ¥­ä¸­']"
        ></div>
        <span>{{ 'gantt.legend.inProgress' | translate }}</span>
      </div>
      <div class="legend-item status-completed">
        <div
          class="legend-color"
          [style.background-color]="statusColors['å®Œäº†']"
        ></div>
        <span>{{ 'gantt.legend.completed' | translate }}</span>
      </div>
    </div>
  </div>

  <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæœ¬ä½“ -->
  <div class="gantt-chart">
    <!-- å·¦ãƒšã‚¤ãƒ³ï¼ˆå›ºå®šã‚«ãƒ©ãƒ ï¼‰ -->
    <div class="gantt-left-pane">
      <!-- å·¦ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="gantt-header-left" #leftHeader>
        <div class="header-cell">{{ 'gantt.header.projectName' | translate }}</div>
        <div class="header-cell">{{ 'gantt.header.taskName' | translate }}</div>
        <div class="header-cell">{{ 'gantt.header.priority' | translate }}</div>
        <div
          class="header-cell"
          [style.width.px]="assigneeColumnWidth"
          [style.min-width.px]="assigneeColumnWidth"
          [style.max-width.px]="assigneeColumnWidth"
          style="white-space: nowrap"
        >
          {{ 'gantt.header.assignee' | translate }}
        </div>
      </div>
      <!-- å·¦ãƒœãƒ‡ã‚£ -->
      <div class="gantt-body-left" #leftPane (scroll)="onLeftScroll()">
        <div *ngFor="let task of tasks" class="task-row">
          <div
            class="task-info"
            [style.width.px]="totalInfoWidth"
            [style.min-width.px]="totalInfoWidth"
            [style.max-width.px]="totalInfoWidth"
          >
            <div
              class="info-cell project-name clickable"
              [ngStyle]="getProjectNameStyle(task)"
              (click)="openProjectDetail(task.projectId)"
              [appTruncateOverflow]="task.projectName"
            ></div>
            <div
              class="info-cell task-name clickable"
              (click)="openTaskDetail(task)"
              [appTruncateOverflow]="task.taskName"
            ></div>
            <div
              class="info-cell priority"
              [ngClass]="'priority-' + task.priority"
            >
              {{ task.priority }}
            </div>
            <div
              class="info-cell assignee"
              [style.width.px]="assigneeColumnWidth"
              [style.min-width.px]="assigneeColumnWidth"
              [style.max-width.px]="assigneeColumnWidth"
              [appTruncateOverflow]="task.assignee"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- å³ãƒšã‚¤ãƒ³ï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼‰ -->
    <div class="gantt-right-pane" #timelineContainer>
      <!-- å³ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="gantt-header-right" #rightHeader>
        <!-- å¹´æœˆãƒ©ãƒ™ãƒ«è¡Œ -->
        <div class="year-month-labels-row">
          <div
            *ngFor="let group of getGroupedDates()"
            class="year-month-label"
            [style.width.px]="getYearMonthLabelWidth(group)"
          >
            {{ formatYearMonth(group.dates[0]) }}
          </div>
        </div>
        <!-- æ—¥ä»˜ã‚»ãƒ«è¡Œ -->
        <div class="date-cells-row">
          <div *ngFor="let date of dateRange" class="date-cell">
            {{ formatDay(date) }}
            <!-- ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¡¨ç¤º -->
            <ng-container *ngIf="getMilestonesForDate(date) as milestones">
              <div
                *ngIf="milestones.length > 0"
                class="milestone-flag"
                (mouseenter)="showMilestoneTooltip($event, milestones)"
                (mouseleave)="hideMilestoneTooltip()"
              >
                ğŸš©
              </div>
            </ng-container>
          </div>
        </div>
      </div>
      <!-- å³ãƒœãƒ‡ã‚£ -->
      <div class="gantt-body-right" #rightPane (scroll)="onRightScroll()">
        <div class="gantt-bars" [style.height.px]="getGanttBarsHeight()">
          <!-- å¹´æœˆãƒ©ãƒ™ãƒ«è¡Œã®ã‚¹ãƒšãƒ¼ã‚¹ -->
          <div class="year-month-labels-spacer-row">
            <div
              *ngFor="let group of getGroupedDates()"
              class="year-month-label-spacer"
              [style.width.px]="getYearMonthLabelWidth(group)"
            ></div>
          </div>
          <!-- èƒŒæ™¯ã®æ—¥ä»˜ã‚»ãƒ« -->
          <div
            class="date-cells-background"
            [style.height.px]="getGanttBarsHeight()"
          >
            <div *ngFor="let date of dateRange" class="date-cell">
              <!-- æ—¥ä»˜ã‚»ãƒ« -->
            </div>
          </div>
          <!-- ã‚¿ã‚¹ã‚¯è¡Œã®åŒºåˆ‡ã‚Šç·š -->
          <div
            class="task-row-lines"
            [style.height.px]="getGanttBarsHeight()"
          >
            <div
              class="task-row-divider"
              [style.top.px]="getTaskHeaderDividerPosition()"
            ></div>
            <div
              *ngFor="let task of tasks; let i = index"
              class="task-row-divider"
              [style.top.px]="getTaskRowLinePosition(i)"
            ></div>
          </div>
          <!-- ã‚¿ã‚¹ã‚¯æœŸé–“ãƒãƒ¼ -->
          <ng-container *ngFor="let task of tasks; let i = index">
            <div
              *ngIf="task.startDate && task.dueDate"
              class="task-bar clickable"
              [style.background-color]="getTaskBarBackground(task)"
              [style.left]="getTaskBarStartPosition(task) + 'px'"
              [style.width]="getTaskBarWidth(task) + 'px'"
              [style.top]="i * 40 + 4 + 'px'"
              [title]="
                task.taskName +
                ' (' +
                task.status +
                ') - ' +
                task.startDate +
                ' ï½ ' +
                task.dueDate
              "
              (click)="openTaskDetail(task)"
            >
              <span
                class="task-bar-text"
                [style.color]="getTaskBarTextColor(task)"
              >
                {{ task.taskName }}
              </span>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— -->
<div
  *ngIf="tooltipVisible"
  class="milestone-tooltip"
  [style.left.px]="tooltipPosition.x"
  [style.top.px]="tooltipPosition.y"
>
  <div class="tooltip-header">
    <span class="tooltip-icon">ğŸš©</span>
    <span class="tooltip-title">{{ 'gantt.tooltip.milestone' | translate }}</span>
  </div>
  <div class="tooltip-content">
    <div
      *ngFor="let milestone of tooltipMilestones"
      class="tooltip-item"
    >
      <div class="tooltip-project">{{ milestone.projectName }}</div>
      <div class="tooltip-name">{{ milestone.name }}</div>
      <div class="tooltip-date">
        {{ milestone.date | date : "yyyy/MM/dd" }}
      </div>
    </div>
  </div>
  <div class="tooltip-arrow"></div>
</div>
