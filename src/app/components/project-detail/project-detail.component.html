<div class="page-header">
  <button mat-button (click)="goBack()" class="back-button">
    <mat-icon>arrow_back</mat-icon>
    戻る
  </button>
  <h2>プロジェクト詳細</h2>
</div>

<div
  *ngIf="project; else loading"
  class="project-card"
  [style.background]="getProjectCardBackground()"
>
  <div class="project-toolbar">
    <mat-slide-toggle
      color="primary"
      [checked]="isInlineEditMode"
      [disabled]="isSavingInlineEdit"
      (change)="onInlineEditToggle($event)"
    >
      編集モード {{ isInlineEditMode ? 'ON' : 'OFF' }}
    </mat-slide-toggle>
  </div>

  <div class="project-header">
    <div class="project-info">
      <ng-container *ngIf="!isInlineEditMode; else inlineEditForm">
        <h3>{{ project.projectName }}</h3>
        <p><strong>概要:</strong> {{ project.overview || "未設定" }}</p>
        <p>
          <strong>期間:</strong>
          {{ toDateDisplay(project.startDate) }} -
          {{ toDateDisplay(project.endDate) }}
        </p>
        <p>
          <strong>責任者:</strong>
          {{ project.responsible || "未設定" }}
        </p>
        <p><strong>メンバー:</strong> {{ project.members || "未設定" }}</p>
        <p><strong>タグ:</strong> {{ project.tags || "-" }}</p>
        <div class="project-attachments" *ngIf="project.attachments?.length; else noProjectAttachments">
          <strong>資料:</strong>
          <div class="attachment-links">
            <a
              *ngFor="let attachment of project.attachments"
              [href]="attachment.url"
              target="_blank"
              rel="noopener noreferrer"
            >
              <mat-icon>{{ attachment.type === 'link' ? 'link' : 'attach_file' }}</mat-icon>
              {{ attachment.name }}
            </a>
          </div>
        </div>
      </ng-container>

      <ng-template #inlineEditForm>
        <form class="project-inline-edit-form" novalidate>
          <mat-form-field appearance="outline" class="full-width-field">
            <mat-label>プロジェクト名</mat-label>
            <input
              matInput
              [(ngModel)]="editableProject!.projectName"
              name="inlineProjectName"
              required
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width-field">
            <mat-label>概要</mat-label>
            <textarea
              matInput
              rows="3"
              [(ngModel)]="editableProject!.overview"
              name="inlineOverview"
            ></textarea>
          </mat-form-field>

          <div class="inline-date-row">
            <mat-form-field appearance="outline" class="date-field">
              <mat-label>開始日</mat-label>
              <input
                matInput
                type="date"
                [(ngModel)]="editableProject!.startDate"
                name="inlineStartDate"
              />
            </mat-form-field>

            <mat-form-field appearance="outline" class="date-field">
              <mat-label>終了日</mat-label>
              <input
                matInput
                type="date"
                [(ngModel)]="editableProject!.endDate"
                name="inlineEndDate"
              />
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width-field">
            <mat-label>責任者</mat-label>
            <input
              matInput
              [(ngModel)]="editableProject!.responsible"
              name="inlineResponsible"
              placeholder="例: 山田太郎"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width-field">
            <mat-label>メンバー</mat-label>
            <textarea
              matInput
              rows="2"
              [(ngModel)]="editableProject!.members"
              name="inlineMembers"
              placeholder="例: 山田太郎, 佐藤花子"
            ></textarea>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width-field">
            <mat-label>タグ</mat-label>
            <input
              matInput
              [(ngModel)]="editableProject!.tags"
              name="inlineTags"
              placeholder="例: #マーケティング, #外部連携"
            />
          </mat-form-field>
        </form>
      </ng-template>
    </div>

    <ng-template #noProjectAttachments>
      <p><strong>資料:</strong> -</p>
    </ng-template>

    <!-- 進捗率円グラフ -->
    <div class="progress-section" *ngIf="projectProgress">
      <app-progress-circle
        [percentage]="projectProgress.progressPercentage"
        [completedTasks]="projectProgress.completedTasks"
        [totalTasks]="projectProgress.totalTasks"
        [size]="120"
        [strokeWidth]="8"
      ></app-progress-circle>
    </div>
  </div>

  <!-- マイルストーン表示 -->
  <div
    *ngIf="project.milestones && project.milestones.length > 0"
    style="margin-top: 20px"
  >
    <h4>マイルストーン</h4>
    <div *ngFor="let milestone of project.milestones" class="milestone-item">
      <div class="milestone-date">
        {{ milestone.date | date : "yyyy/MM/dd" }}
      </div>
      <div class="milestone-name">{{ milestone.name }}</div>
    </div>
  </div>

  <div style="margin-top: 20px">
    <button
      mat-raised-button
      color="primary"
      (click)="openEditProjectDialog()"
      [disabled]="isInlineEditMode"
    >
      プロジェクト編集
    </button>
  </div>

  <!-- プロジェクトチャット -->
  <app-project-chat *ngIf="projectId" [projectId]="projectId">
  </app-project-chat>
</div>

<!-- タスク一覧セクション -->
<div
  *ngIf="project"
  class="tasks-section"
  [style.background]="getTasksSectionBackground()"
>
  <div class="tasks-header">
    <h3>タスク一覧</h3>
    <div class="tasks-actions">
      <button mat-raised-button color="accent" (click)="openAddTaskDialog()">
        ＋ タスク
      </button>
      <button mat-raised-button color="accent" (click)="exportToCSV()">
        <mat-icon>download</mat-icon>
        出力
      </button>
    </div>
  </div>

  <!-- フィルター -->
  <div class="filter-section">
    <mat-form-field appearance="outline">
      <mat-label>ステータス</mat-label>
      <mat-select [(ngModel)]="filterStatus" (selectionChange)="applyFilter()">
        <mat-option value="">すべて</mat-option>
        <mat-option *ngFor="let status of statusOptions" [value]="status">
          {{ status }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>優先度</mat-label>
      <mat-select
        [(ngModel)]="filterPriority"
        (selectionChange)="applyFilter()"
      >
        <mat-option value="">すべて</mat-option>
        <mat-option *ngFor="let priority of priorityOptions" [value]="priority">
          {{ priority }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>担当者</mat-label>
      <mat-select
        [(ngModel)]="filterAssignee"
        (selectionChange)="applyFilter()"
        placeholder="担当者を選択"
      >
        <mat-option value="">すべて</mat-option>
        <mat-option *ngFor="let assignee of assigneeOptions" [value]="assignee">
          {{ assignee }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>期日</mat-label>
      <input
        matInput
        #filterDueDateInput
        type="date"
        [(ngModel)]="filterDueDate"
        (change)="applyFilter()"
      />
      <button
        mat-icon-button
        matSuffix
        type="button"
        (click)="openNativeDatePicker(filterDueDateInput)"
        aria-label="期日を選択"
      >
        <mat-icon>event</mat-icon>
      </button>
    </mat-form-field>

    <button mat-stroked-button (click)="resetFilter()">
      <mat-icon>refresh</mat-icon>
      リセット
    </button>
  </div>

  <!-- タスクカード一覧 -->
  <div class="tasks-grid">
    <mat-card
      *ngFor="let task of filteredTasks"
      class="task-card"
      [ngClass]="{ completed: task.status === '完了' }"
      (click)="goToTaskDetail(task.id!)"
    >
      <mat-card-header>
        <mat-card-title>{{ task.taskName }}</mat-card-title>
        <mat-card-subtitle>
          <mat-chip-set>
            <mat-chip [color]="getStatusColor(task.status)" selected>
              {{ task.status }}
            </mat-chip>
            <mat-chip [color]="getPriorityColor(task.priority)" selected>
              {{ task.priority }}
            </mat-chip>
          </mat-chip-set>
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="task-details">
          <div class="task-detail-item">
            <mat-icon>person</mat-icon>
            <span>{{ task.assignee }}</span>
          </div>
          <div class="task-detail-item">
            <mat-icon>schedule</mat-icon>
            <span>{{ task.dueDate }}</span>
          </div>
          <div
            class="task-detail-item"
            *ngIf="task.parentTaskId && taskNameById[task.parentTaskId]"
          >
            <mat-icon>subdirectory_arrow_right</mat-icon>
            <span>親タスク：{{ taskNameById[task.parentTaskId] }}</span>
          </div>
          <div class="task-detail-item" *ngIf="task.description">
            <mat-icon>description</mat-icon>
            <span>{{ task.description }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- タスクが存在しない場合 -->
  <div *ngIf="filteredTasks.length === 0" class="no-tasks">
    <mat-icon>assignment</mat-icon>
    <p>タスクがありません</p>
    <button mat-raised-button color="primary" (click)="openAddTaskDialog()">
      ＋ タスクを追加
    </button>
  </div>
</div>

<ng-template #loading>
  <p>読み込み中...</p>
</ng-template>
