<div class="page-header">
  <button mat-button (click)="goBack()" class="back-button">
    <mat-icon>arrow_back</mat-icon>
    {{ 'projectDetail.back' | translate }}
  </button>
  <h2>{{ 'projectDetail.title' | translate }}</h2>
</div>

<div
  *ngIf="project; else loading"
  class="project-card"
  [style.background]="getProjectCardBackground()"
>
  <div class="project-toolbar">
    <mat-slide-toggle
      color="primary"
      [checked]="isInlineEditMode"
      [disabled]="isSavingInlineEdit"
      (change)="onInlineEditToggle($event)"
    >
      {{ 'projectDetail.editMode' | translate }} {{ isInlineEditMode ? ('projectDetail.on' | translate) : ('projectDetail.off' | translate) }}
    </mat-slide-toggle>
  </div>

  <div class="project-header">
    <div class="project-info">
      <div class="project-info-display" *ngIf="!isInlineEditMode; else inlineEditForm">
        <h3>{{ project.projectName }}</h3>
        <p><strong>{{ 'projectDetail.overview' | translate }}:</strong> {{ project.overview || ("projectDetail.notSet" | translate) }}</p>
        <p>
          <strong>{{ 'projectDetail.period' | translate }}:</strong>
          {{ toDateDisplay(project.startDate) }} -
          {{ toDateDisplay(project.endDate) }}
        </p>
        <p>
          <strong>{{ 'projectDetail.responsible' | translate }}:</strong>
          {{ getResponsiblesDisplay() }}
        </p>
        <p><strong>{{ 'projectDetail.members' | translate }}:</strong> {{ getMembersDisplay() || ("projectDetail.notSet" | translate) }}</p>
        <div
          class="project-attachments"
          *ngIf="project.attachments?.length; else noProjectAttachments"
        >
          <strong>{{ 'projectDetail.materials' | translate }}:</strong>
          <div class="attachment-links">
            <a
              *ngFor="let attachment of project.attachments"
              [href]="attachment.url"
              target="_blank"
              rel="noopener noreferrer"
            >
              <mat-icon>
                {{ attachment.type === 'link' ? 'link' : 'attach_file' }}
              </mat-icon>
              {{ attachment.name }}
            </a>
          </div>
        </div>
      </div>

      <ng-template #inlineEditForm>
        <form class="project-inline-edit-form" novalidate>
          <mat-form-field appearance="outline" class="full-width-field">
            <mat-label>{{ 'projectDetail.projectName' | translate }}</mat-label>
            <input
              matInput
              [(ngModel)]="editableProject!.projectName"
              name="inlineProjectName"
              required
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width-field">
            <mat-label>{{ 'projectDetail.overview' | translate }}</mat-label>
            <textarea
              matInput
              rows="3"
              [(ngModel)]="editableProject!.overview"
              name="inlineOverview"
            ></textarea>
          </mat-form-field>

          <div class="inline-date-row">
            <div class="date-field">
              <label for="inlineStartDate">{{ 'projectDetail.startDate' | translate }}</label>
              <div class="date-input-wrapper">
                <input
                  id="inlineStartDate"
                  class="date-input"
                  type="date"
                  [(ngModel)]="editableProject!.startDate"
                  name="inlineStartDate"
                />
                <mat-icon class="date-icon">event</mat-icon>
              </div>
            </div>

            <div class="date-field">
              <label for="inlineEndDate">{{ 'projectDetail.endDate' | translate }}</label>
              <div class="date-input-wrapper">
                <input
                  id="inlineEndDate"
                  class="date-input"
                  type="date"
                  [(ngModel)]="editableProject!.endDate"
                  name="inlineEndDate"
                  [min]="editableProject!.startDate || ''"
                />
                <mat-icon class="date-icon">event</mat-icon>
              </div>
            </div>
          </div>

          <mat-form-field appearance="outline" class="full-width-field">
            <mat-label>{{ 'projectDetail.responsible' | translate }}</mat-label>
            <mat-select
              multiple
              [(ngModel)]="selectedResponsibleIds"
              name="inlineResponsibleIds"
              (ngModelChange)="onResponsibleSelectionChange($event)"
              [disabled]="membersLoading"
            >
              <mat-option *ngFor="let member of members" [value]="member.id">
                {{ member.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div class="selected-members-chips" *ngIf="selectedResponsibles.length > 0">
            <mat-chip-set>
              <mat-chip
                *ngFor="let member of selectedResponsibles"
                selected
                removable
                (removed)="removeResponsible(member)"
                class="member-chip-inline responsible-chip"
              >
                {{ member.name }}
                <mat-icon matChipRemove>close</mat-icon>
              </mat-chip>
            </mat-chip-set>
          </div>

          <mat-form-field appearance="outline" class="full-width-field">
            <mat-label>{{ 'projectDetail.assignee' | translate }}</mat-label>
            <mat-select
              multiple
              [(ngModel)]="selectedMemberIds"
              name="inlineMemberIds"
              (ngModelChange)="onMembersSelectionChange($event)"
              placeholder="{{ 'projectDetail.selectMember' | translate }}"
              [disabled]="membersLoading"
            >
              <mat-option *ngFor="let member of members" [value]="member.id">
                {{ member.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div class="selected-members-chips" *ngIf="selectedMembers.length > 0">
            <mat-chip-set>
              <mat-chip
                *ngFor="let member of selectedMembers"
                selected
                removable
                (removed)="removeSelectedMember(member)"
              >
                {{ member.name }}
                <mat-icon matChipRemove>close</mat-icon>
              </mat-chip>
            </mat-chip-set>
          </div>

          <div class="inline-attachments">
            <div class="attachment-actions">
              <button
                mat-stroked-button
                type="button"
                (click)="fileInput.click()"
                [disabled]="isUploading"
              >
                {{ 'projectDetail.addFile' | translate }}
              </button>
              <input
                #fileInput
                type="file"
                multiple
                [accept]="fileAccept"
                (change)="onFilesSelected($event)"
                hidden
              />

              <mat-form-field appearance="outline" class="url-input-field">
                <mat-label>{{ 'projectDetail.enterUrl' | translate }}</mat-label>
                <input
                  matInput
                  [(ngModel)]="newUrlInput"
                  placeholder="https://example.com"
                  (keyup.enter)="addUrl(newUrlInput)"
                  name="newUrl"
                />
              </mat-form-field>
              <button
                mat-stroked-button
                type="button"
                (click)="addUrl(newUrlInput)"
              >
                {{ 'projectDetail.add' | translate }}
              </button>
            </div>

            <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º -->
            <div class="pending-files" *ngIf="pendingFiles.length > 0">
              <p>{{ 'projectDetail.uploadingFiles' | translate }}:</p>
              <div class="pending-files-list">
                <div
                  class="pending-file-item"
                  *ngFor="let pending of pendingFiles"
                >
                  <mat-icon class="pending-icon">file_upload</mat-icon>
                  <span class="pending-filename">{{ pending.file.name }}</span>
                </div>
              </div>
            </div>

            <div class="attachment-list" *ngIf="editableAttachments.length > 0">
              <h4>{{ 'projectDetail.registeredMaterials' | translate }}</h4>
              <div
                class="attachment-chip"
                *ngFor="let attachment of editableAttachments; trackBy: trackAttachment"
              >
                <span class="material-icon">{{ attachment.type === 'link' ? 'ðŸ”—' : 'ðŸ“Ž' }}</span>
                <a
                  [href]="attachment.url"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="material-link"
                >
                  {{ attachment.type === 'link' ? extractUrlLabel(attachment.url) : attachment.name }}
                </a>
                <ng-container *ngIf="attachment.type === 'file' && attachment.size">
                  <span class="size-text">({{ formatFileSize(attachment.size) }})</span>
                </ng-container>
                <button
                  mat-icon-button
                  type="button"
                  (click)="removeAttachment(attachment)"
                  [attr.aria-label]="'projectDetail.removeAttachment' | translate"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>

            <div
              class="no-attachments"
              *ngIf="editableAttachments.length === 0 && pendingFiles.length === 0"
            >
              {{ 'projectDetail.noRegisteredMaterials' | translate }}
            </div>

            <div class="uploading-indicator" *ngIf="isUploading">
              <mat-spinner diameter="24"></mat-spinner>
              <span>{{ 'projectDetail.uploadingAttachments' | translate }}</span>
            </div>
          </div>

          <div class="inline-milestones">
            <h4>{{ 'projectDetail.milestones' | translate }}</h4>
            <div class="milestones-container">
              <div
                *ngFor="let milestone of editableMilestones; let i = index; trackBy: trackMilestone"
                class="milestone-item"
              >
                <div class="milestone-date-field">
                  <label [attr.for]="'inlineMilestoneDate' + i">{{ 'projectDetail.date' | translate }}</label>
                  <div class="date-input-wrapper">
                    <input
                      [id]="'inlineMilestoneDate' + i"
                      class="date-input"
                      type="date"
                      [(ngModel)]="milestone.date"
                      name="inlineMilestoneDate{{ i }}"
                    />
                    <mat-icon class="date-icon">event</mat-icon>
                  </div>
                </div>
                <mat-form-field appearance="outline" class="milestone-name">
                  <mat-label>{{ 'projectDetail.milestoneName' | translate }}</mat-label>
                  <input
                    matInput
                    type="text"
                    [(ngModel)]="milestone.name"
                    name="inlineMilestoneName{{ i }}"
                    placeholder="{{ 'projectDetail.milestoneName' | translate }}"
                  />
                </mat-form-field>
                <button
                  mat-icon-button
                  type="button"
                  (click)="removeMilestone(i)"
                  [attr.aria-label]="'projectDetail.removeMilestone' | translate"
                  color="warn"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <button mat-button type="button" (click)="addMilestone()">
                <mat-icon>add</mat-icon>
                {{ 'projectDetail.addMilestone' | translate }}
              </button>
            </div>
          </div>
        </form>
      </ng-template>
    </div>

    <ng-template #noProjectAttachments>
      <p><strong>{{ 'projectDetail.materials' | translate }}:</strong> -</p>
    </ng-template>

    <!-- é€²æ—çŽ‡å††ã‚°ãƒ©ãƒ• -->
    <div class="progress-section" *ngIf="projectProgress">
      <app-progress-circle
        [percentage]="projectProgress.progressPercentage"
        [completedTasks]="projectProgress.completedTasks"
        [totalTasks]="projectProgress.totalTasks"
        [size]="120"
        [strokeWidth]="8"
      ></app-progress-circle>
    </div>
  </div>

  <!-- ãƒžã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¡¨ç¤º -->
  <div
    *ngIf="project.milestones && project.milestones.length > 0"
    style="margin-top: 20px"
  >
    <h4>{{ 'projectDetail.milestones' | translate }}</h4>
    <div *ngFor="let milestone of project.milestones" class="milestone-item">
      <div class="milestone-date">
        {{ milestone.date | date : "yyyy/MM/dd" }}
      </div>
      <div class="milestone-name">{{ milestone.name }}</div>
    </div>
  </div>

  <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ£ãƒƒãƒˆ -->
  <app-project-chat *ngIf="projectId" [projectId]="projectId" [chatTitle]="'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ£ãƒƒãƒˆ'" [members]="members">
  </app-project-chat>

  <div
    class="project-delete-actions"
    *ngIf="isInlineEditMode"
  >
    <button
      mat-raised-button
      color="warn"
      type="button"
      (click)="confirmProjectDeletion()"
      [disabled]="isSavingInlineEdit || isDeletingProject"
    >
      <mat-icon>delete</mat-icon>
      {{ 'projectDetail.deleteProject' | translate }}
    </button>
  </div>
</div>

<!-- ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div
  *ngIf="project"
  class="tasks-section"
  [style.background]="getTasksSectionBackground()"
>
  <div class="tasks-header">
    <h3>{{ 'projectDetail.taskList' | translate }}</h3>
    <div class="tasks-actions">
      <button mat-raised-button color="accent" (click)="openAddTaskDialog()">
        {{ 'projectDetail.addTask' | translate }}
      </button>
      <button mat-raised-button color="accent" (click)="exportToCSV()">
        <mat-icon>download</mat-icon>
        {{ 'projectDetail.export' | translate }}
      </button>
    </div>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="filter-section">
    <mat-form-field appearance="outline">
      <mat-label>{{ 'projectDetail.status' | translate }}</mat-label>
      <mat-select [(ngModel)]="filterStatus" (selectionChange)="applyFilter()">
        <mat-option value="">{{ 'projectDetail.all' | translate }}</mat-option>
        <mat-option *ngFor="let status of statusOptions" [value]="status">
          {{ status }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>{{ 'projectDetail.priority' | translate }}</mat-label>
      <mat-select
        [(ngModel)]="filterPriority"
        (selectionChange)="applyFilter()"
      >
        <mat-option value="">{{ 'projectDetail.all' | translate }}</mat-option>
        <mat-option *ngFor="let priority of priorityOptions" [value]="priority">
          {{ priority }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>{{ 'projectDetail.assignee' | translate }}</mat-label>
      <mat-select
        [(ngModel)]="filterAssignee"
        (selectionChange)="applyFilter()"
        placeholder="{{ 'projectDetail.selectAssignee' | translate }}"
      >
        <mat-option value="">{{ 'projectDetail.all' | translate }}</mat-option>
        <mat-option *ngFor="let assignee of assigneeOptions" [value]="assignee">
          {{ assignee }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>{{ 'projectDetail.dueDate' | translate }}</mat-label>
      <input
        matInput
        #filterDueDateInput
        type="date"
        [(ngModel)]="filterDueDate"
        (change)="applyFilter()"
      />
      <button
        mat-raised-button type="button" [disabled]="filterDueDateInput.disabled" (click)="openNativeDatePicker(filterDueDateInput)" [attr.aria-label]="'projectDetail.selectDueDate' | translate">
        <mat-icon>event</mat-icon>
      </button>
    </mat-form-field>

    <button mat-stroked-button (click)="resetFilter()">
      <mat-icon>refresh</mat-icon>
      {{ 'projectDetail.reset' | translate }}
    </button>
  </div>

  <!-- ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
  <div class="tasks-grid">
    <mat-card
      *ngFor="let task of filteredTasks"
      class="task-card"
      [ngClass]="{ completed: task.status === 'å®Œäº†' }"
      (click)="goToTaskDetail(task.id!)"
    >
      <mat-card-header class="task-card-header">
        <mat-card-title>
          <span class="task-card-title-text">{{ task.taskName }}</span>
        </mat-card-title>
        <div class="task-card-meta">
          <mat-chip-set>
            <mat-chip
              class="status-chip"
              [ngClass]="'status-' + task.status"
              selected
            >
              {{ task.status }}
            </mat-chip>
            <mat-chip
              class="priority-chip"
              [ngClass]="'priority-' + task.priority"
              selected
            >
              {{ task.priority }}
            </mat-chip>
          </mat-chip-set>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="task-details">
          <div class="task-main-info">
            <div class="task-detail-item task-detail-member">
              <mat-icon>person</mat-icon>
              <span class="task-member-name">{{ getTaskAssigneeDisplay(task) }}</span>
              <div class="task-member-due">
                <mat-icon>schedule</mat-icon>
                <span>{{ task.dueDate }}</span>
              </div>
            </div>
          </div>
          <div
            class="task-detail-item"
            *ngIf="task.parentTaskId && taskNameById[task.parentTaskId]"
          >
            <mat-icon>subdirectory_arrow_right</mat-icon>
            <span>{{ 'projectDetail.parentTask' | translate }}: {{ taskNameById[task.parentTaskId] }}</span>
          </div>
          <div
            class="task-detail-item"
            *ngIf="
              task.description &&
              !(task.parentTaskId && taskNameById[task.parentTaskId])
            "
          >
            <mat-icon>description</mat-icon>
            <span>{{ task.description }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- ã‚¿ã‚¹ã‚¯ãŒå­˜åœ¨ã—ãªã„å ´åˆ -->
  <div *ngIf="filteredTasks.length === 0" class="no-tasks">
    <mat-icon>assignment</mat-icon>
    <p>{{ 'projectDetail.noTasks' | translate }}</p>
    <button mat-raised-button color="primary" (click)="openAddTaskDialog()">
      {{ 'projectDetail.addTask' | translate }}
    </button>
  </div>
</div>

<ng-template #loading>
  <p>{{ 'projectDetail.loading' | translate }}</p>
</ng-template>
