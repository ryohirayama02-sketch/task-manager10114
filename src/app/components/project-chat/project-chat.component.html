<div class="project-chat-container">
  <h4>{{ chatTitle }}</h4>

  <!-- ローディング表示 -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="30"></mat-spinner>
    <p>{{ 'projectChat.loading' | translate }}</p>
  </div>

  <!-- メッセージ一覧 -->
  <div *ngIf="!loading" class="messages-container">
    <div
      *ngFor="let message of messages"
      class="message-item"
      [ngClass]="{ 'own-message': message.senderId === currentUserId }"
    >
      <div class="message-header">
        <span class="message-sender">{{ message.sender }}</span>
        <span class="message-time">{{ formatTime(message.timestamp) }}</span>
      </div>
      <div class="message-content">
        <span *ngIf="!message.mentions || message.mentions.length === 0">
          {{ message.content }}
        </span>
        <ng-container *ngIf="message.mentions && message.mentions.length > 0">
          <span [innerHTML]="highlightMentions(message.content, message.mentions)"></span>
        </ng-container>
      </div>
    </div>

    <!-- メッセージが空の場合 -->
    <div *ngIf="messages.length === 0" class="no-messages">
      <p>{{ 'projectChat.noMessages' | translate }}</p>
    </div>
  </div>

  <!-- メッセージ入力フォーム -->
  <div class="chat-input-section">
    <div class="mention-candidates" *ngIf="showMentionCandidates">
      <div
        *ngFor="let candidate of mentionCandidates; let i = index"
        class="mention-candidate-item"
        [ngClass]="{ selected: i === selectedMentionCandidate }"
        (click)="selectMentionCandidate(candidate)"
        role="option"
        [attr.aria-selected]="i === selectedMentionCandidate"
      >
        <img
          *ngIf="candidate.photoURL"
          [src]="candidate.photoURL"
          class="member-avatar"
          alt="{{ candidate.displayName }}"
        />
        <div *ngIf="!candidate.photoURL" class="member-avatar-placeholder">
          {{ candidate.displayName.charAt(0).toUpperCase() }}
        </div>
        <span class="member-name">{{ candidate.displayName }}</span>
      </div>
    </div>

    <div class="input-group">
      <textarea
        #messageInput
        class="message-textarea"
        [(ngModel)]="newMessage"
        (change)="onMessageInputChange($event)"
        (input)="onMessageInputChange($event)"
        (keydown)="onMentionKeyDown($event)"
        [placeholder]="'projectChat.messagePlaceholder' | translate"
        rows="3"
        maxlength="100"
      ></textarea>
      <button
        mat-raised-button
        color="primary"
        (click)="sendMessage()"
        [disabled]="!newMessage.trim()"
        class="send-button"
      >
        <mat-icon>send</mat-icon>
        {{ 'projectChat.send' | translate }}
      </button>
    </div>
  </div>
</div>
