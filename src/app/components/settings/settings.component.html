<div class="settings-container">
  <h1>{{ "settings.title" | translate }}</h1>

  <!-- ローディング表示 -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>{{ "settings.loading" | translate }}</p>
  </div>

  <!-- 設定メニュー -->
  <div *ngIf="!isLoading" class="settings-menu">
    <mat-card class="menu-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>settings</mat-icon>
          {{ "settings.menu.title" | translate }}
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="menu-buttons">
          <button
            mat-raised-button
            color="primary"
            class="menu-button"
            [class.active]="selectedSettingsTab === 'notifications'"
            (click)="selectedSettingsTab = 'notifications'"
          >
            <mat-icon>notifications</mat-icon>
            {{ "settings.menu.notifications" | translate }}
          </button>

          <button
            mat-raised-button
            color="accent"
            class="menu-button"
            [class.active]="selectedSettingsTab === 'home'"
            (click)="selectedSettingsTab = 'home'"
          >
            <mat-icon>home</mat-icon>
            {{ "settings.menu.home" | translate }}
          </button>

          <button
            mat-raised-button
            class="menu-button"
            color="primary"
            [class.active]="selectedSettingsTab === 'language'"
            (click)="selectedSettingsTab = 'language'"
          >
            <mat-icon>translate</mat-icon>
            {{ "settings.menu.language" | translate }}
          </button>

          <button
            mat-raised-button
            class="menu-button"
            color="primary"
            [class.active]="selectedSettingsTab === 'roomInfo'"
            (click)="selectedSettingsTab = 'roomInfo'"
          >
            <mat-icon>info</mat-icon>
            {{ "settings.menu.roomInfo" | translate }}
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- 通知設定 -->
  <div
    *ngIf="
      !isLoading &&
      selectedSettingsTab === 'notifications' &&
      notificationSettings
    "
    class="settings-content"
  >
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>notifications</mat-icon>
          {{ "settings.notifications.title" | translate }}
        </mat-card-title>
        <mat-card-subtitle>
          {{ "settings.notifications.subtitle" | translate }}
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <!-- 通知先設定 -->
        <mat-expansion-panel class="expansion-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>send</mat-icon>
              {{ "settings.notifications.targets" | translate }}
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="notification-channels">
            <!-- メール通知設定 -->
            <div class="channel-section">
              <div class="channel-header">
                <mat-slide-toggle
                  [(ngModel)]="
                    notificationSettings.notificationChannels.email.enabled
                  "
                  name="emailEnabled"
                >
                  <mat-icon>email</mat-icon>
                  {{ "settings.notifications.email" | translate }}
                </mat-slide-toggle>
              </div>

              <div
                *ngIf="notificationSettings.notificationChannels.email.enabled"
                class="channel-settings"
              >
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{
                    "settings.notifications.address" | translate
                  }}</mat-label>
                  <input
                    matInput
                    type="email"
                    [(ngModel)]="
                      notificationSettings.notificationChannels.email.address
                    "
                    name="emailAddress"
                    placeholder="example@email.com"
                  />
                </mat-form-field>
              </div>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- タスク期限通知設定 -->
        <mat-expansion-panel class="expansion-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>schedule</mat-icon>
              {{ "settings.deadline.title" | translate }}
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="deadline-settings">
            <div class="setting-row">
              <mat-slide-toggle
                [(ngModel)]="
                  notificationSettings.taskDeadlineNotifications.enabled
                "
                name="deadlineEnabled"
              >
                {{ "settings.deadline.enable" | translate }}
              </mat-slide-toggle>
            </div>

            <div
              *ngIf="notificationSettings.taskDeadlineNotifications.enabled"
              class="deadline-options"
            >
              <div class="setting-row">
                <label>{{ "settings.deadline.timing" | translate }}:</label>
                <div class="checkbox-group">
                  <mat-checkbox
                    *ngFor="let day of deadlineNotificationDays"
                    [checked]="isDeadlineDaySelected(day)"
                    (change)="updateDeadlineDays(day, $event.checked)"
                  >
                    {{ day }}{{ "settings.deadline.daysSuffix" | translate }}
                  </mat-checkbox>
                </div>
              </div>

              <div class="setting-row">
                <label>{{
                  "settings.common.notifyTime" | translate
                }}</label>
                <div class="time-picker">
                  <mat-form-field appearance="outline" class="time-field">
                    <mat-label>{{ "taskDetail.hour" | translate }}</mat-label>
                    <mat-select
                      [(ngModel)]="taskDeadlineTime.hour"
                      name="deadlineHour"
                    >
                      <mat-option
                        *ngFor="let hour of hourOptions"
                        [value]="hour.value"
                      >
                        {{ hour.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <span class="time-separator">:</span>
                  <mat-form-field appearance="outline" class="time-field">
                    <mat-label>{{ "taskDetail.minute" | translate }}</mat-label>
                    <mat-select
                      [(ngModel)]="taskDeadlineTime.minute"
                      name="deadlineMinute"
                    >
                      <mat-option
                        *ngFor="let minute of minuteOptions"
                        [value]="minute.value"
                      >
                        {{ minute.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- 通知オフ期間設定 -->
        <mat-expansion-panel class="expansion-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>bedtime</mat-icon>
              {{ "settings.quiet.title" | translate }}
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="quiet-hours-settings">
            <div class="setting-row">
              <mat-slide-toggle
                [checked]="notificationSettings.quietHours?.enabled ?? false"
                (change)="onQuietHoursEnabledChange($event)"
              >
                {{ "settings.quiet.enable" | translate }}
              </mat-slide-toggle>
            </div>

            <div
              *ngIf="notificationSettings.quietHours.enabled"
              class="quiet-hours-options"
            >
              <div class="time-range">
                <div class="time-picker">
                  <label>{{
                    "settings.quiet.start" | translate
                  }}</label>
                  <mat-form-field appearance="outline" class="time-field">
                    <mat-label>{{ "taskDetail.hour" | translate }}</mat-label>
                    <mat-select
                      [(ngModel)]="quietStartTime.hour"
                      name="startHour"
                    >
                      <mat-option
                        *ngFor="let hour of hourOptions"
                        [value]="hour.value"
                      >
                        {{ hour.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <span class="time-separator">:</span>
                  <mat-form-field appearance="outline" class="time-field">
                    <mat-label>{{ "taskDetail.minute" | translate }}</mat-label>
                    <mat-select
                      [(ngModel)]="quietStartTime.minute"
                      name="startMinute"
                    >
                      <mat-option
                        *ngFor="let minute of minuteOptions"
                        [value]="minute.value"
                      >
                        {{ minute.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="time-picker">
                  <label>{{ "settings.quiet.end" | translate }}</label>
                  <mat-form-field appearance="outline" class="time-field">
                    <mat-label>{{ "taskDetail.hour" | translate }}</mat-label>
                    <mat-select
                      [(ngModel)]="quietEndTime.hour"
                      name="endHour"
                    >
                      <mat-option
                        *ngFor="let hour of hourOptions"
                        [value]="hour.value"
                      >
                        {{ hour.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <span class="time-separator">:</span>
                  <mat-form-field appearance="outline" class="time-field">
                    <mat-label>{{ "taskDetail.minute" | translate }}</mat-label>
                    <mat-select
                      [(ngModel)]="quietEndTime.minute"
                      name="endMinute"
                    >
                      <mat-option
                        *ngFor="let minute of minuteOptions"
                        [value]="minute.value"
                      >
                        {{ minute.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>

              <div class="setting-row">
                <mat-checkbox
                  [(ngModel)]="notificationSettings.quietHours.weekends"
                  name="weekendsOff"
                >
                  {{ "settings.quiet.weekend" | translate }}
                </mat-checkbox>
              </div>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- 作業時間オーバー通知設定 -->
        <mat-expansion-panel class="expansion-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>timer</mat-icon>
              {{ "settings.worktime.title" | translate }}
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="work-time-settings">
            <div class="setting-row">
              <mat-slide-toggle
                [(ngModel)]="
                  notificationSettings.workTimeOverflowNotifications.enabled
                "
                name="workTimeEnabled"
              >
                {{ "settings.worktime.enable" | translate }}
              </mat-slide-toggle>
            </div>

            <div
              *ngIf="notificationSettings.workTimeOverflowNotifications.enabled"
              class="work-time-options"
            >
              <div class="setting-row">
                <mat-form-field appearance="outline">
                  <mat-label>{{
                    "settings.worktime.period" | translate
                  }}</mat-label>
                  <mat-select
                    [(ngModel)]="
                      notificationSettings.workTimeOverflowNotifications
                        .checkPeriodDays
                    "
                    name="checkPeriod"
                  >
                    <mat-option
                      *ngFor="let days of checkPeriodOptions"
                      [value]="days"
                    >
                      {{ days
                      }}{{ "settings.worktime.periodSuffix" | translate }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>{{
                    "settings.worktime.max" | translate
                  }}</mat-label>
                  <mat-select
                    [(ngModel)]="
                      notificationSettings.workTimeOverflowNotifications
                        .maxWorkHours
                    "
                    name="maxWorkHours"
                  >
                    <mat-option
                      *ngFor="let hours of workTimeOptions"
                      [value]="hours"
                    >
                      {{ hours }}{{ "settings.worktime.maxSuffix" | translate }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="setting-row">
                <label>{{
                  "settings.common.notifyTime" | translate
                }}</label>
                <div class="time-picker">
                  <mat-form-field appearance="outline" class="time-field">
                    <mat-label>{{ "taskDetail.hour" | translate }}</mat-label>
                    <mat-select
                      [(ngModel)]="workTimeOverflowTime.hour"
                      name="workTimeHour"
                    >
                      <mat-option
                        *ngFor="let hour of hourOptions"
                        [value]="hour.value"
                      >
                        {{ hour.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <span class="time-separator">:</span>
                  <mat-form-field appearance="outline" class="time-field">
                    <mat-label>{{ "taskDetail.minute" | translate }}</mat-label>
                    <mat-select
                      [(ngModel)]="workTimeOverflowTime.minute"
                      name="workTimeMinute"
                    >
                      <mat-option
                        *ngFor="let minute of minuteOptions"
                        [value]="minute.value"
                      >
                        {{ minute.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>

              <div class="notification-targets">
                <mat-checkbox
                  [(ngModel)]="
                    notificationSettings.workTimeOverflowNotifications
                      .notifyManager
                  "
                  name="notifyManager"
                >
                  {{ "settings.worktime.notifyManager" | translate }}
                </mat-checkbox>

                <mat-checkbox
                  [(ngModel)]="
                    notificationSettings.workTimeOverflowNotifications
                      .notifyAssignee
                  "
                  name="notifyAssignee"
                >
                  {{ "settings.worktime.notifyAssignee" | translate }}
                </mat-checkbox>
              </div>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- 今日のタスク通知設定 -->
        <mat-expansion-panel class="expansion-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>today</mat-icon>
              {{ "settings.daily.title" | translate }}
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="daily-reminder-settings">
            <div class="setting-row">
              <mat-slide-toggle
                [(ngModel)]="notificationSettings.dailyDeadlineReminder.enabled"
                name="dailyReminderEnabled"
              >
                {{ "settings.daily.enable" | translate }}
              </mat-slide-toggle>
            </div>

            <div
              *ngIf="notificationSettings.dailyDeadlineReminder.enabled"
              class="daily-reminder-options"
            >
              <div class="setting-row">
                <label>{{
                  "settings.common.notifyTime" | translate
                }}</label>
                <div class="time-picker">
                  <mat-form-field appearance="outline" class="time-field">
                    <mat-label>{{ "taskDetail.hour" | translate }}</mat-label>
                    <mat-select
                      [(ngModel)]="dailyReminderTime.hour"
                      name="dailyReminderHour"
                    >
                      <mat-option
                        *ngFor="let hour of hourOptions"
                        [value]="hour.value"
                      >
                        {{ hour.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <span class="time-separator">:</span>
                  <mat-form-field appearance="outline" class="time-field">
                    <mat-label>{{ "taskDetail.minute" | translate }}</mat-label>
                    <mat-select
                      [(ngModel)]="dailyReminderTime.minute"
                      name="dailyReminderMinute"
                    >
                      <mat-option
                        *ngFor="let minute of minuteOptions"
                        [value]="minute.value"
                      >
                        {{ minute.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-card-content>

      <mat-card-actions>
        <button
          mat-raised-button
          color="primary"
          (click)="sendTaskDeadlineNotificationsTest()"
          [disabled]="isSaving"
        >
          <mat-icon>schedule</mat-icon>
          タスク期限通知テスト
        </button>

        <button
          mat-raised-button
          color="primary"
          (click)="sendWorkTimeOverflowNotificationsTest()"
          [disabled]="isSaving"
        >
          <mat-icon>timer</mat-icon>
          作業時間オーバー通知テスト
        </button>

        <button
          mat-raised-button
          color="primary"
          (click)="sendDailyTaskRemindersTest()"
          [disabled]="isSaving"
        >
          <mat-icon>today</mat-icon>
          今日のタスク通知テスト
        </button>

        <button
          mat-raised-button
          color="primary"
          (click)="saveNotificationSettings()"
          [disabled]="isSaving"
        >
          <mat-icon>save</mat-icon>
          {{ (isSaving ? "settings.saving" : "settings.save") | translate }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- ホーム画面設定 -->
  <div
    *ngIf="!isLoading && selectedSettingsTab === 'home'"
    class="settings-content"
  >
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>home</mat-icon>
          {{ "settings.home.title" | translate }}
        </mat-card-title>
        <mat-card-subtitle>
          {{ "settings.home.subtitle" | translate }}
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="home-screen-selection">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ "settings.home.field" | translate }}</mat-label>
            <mat-select
              [(ngModel)]="selectedHomeScreen"
              (selectionChange)="onHomeScreenChange()"
              [disabled]="isSaving"
              name="homeScreen"
            >
              <mat-option
                *ngFor="let option of homeScreenOptions"
                [value]="option.value"
              >
                <mat-icon>{{ option.icon }}</mat-icon>
                {{ getHomeScreenLabel(option.value) }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- 言語設定 -->
  <div
    *ngIf="!isLoading && selectedSettingsTab === 'language'"
    class="settings-content"
  >
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>translate</mat-icon>
          {{ "settings.language.title" | translate }}
        </mat-card-title>
        <mat-card-subtitle>
          {{ "settings.language.subtitle" | translate }}
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="language-settings">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ "settings.language.field" | translate }}</mat-label>
            <mat-select
              [(ngModel)]="selectedLanguage"
              name="uiLanguage"
              [disabled]="isSavingLanguage"
            >
              <mat-option
                *ngFor="let option of languageOptions"
                [value]="option.value"
              >
                {{ option.labelKey | translate }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <p class="language-description">
            {{ "settings.language.description" | translate }}
          </p>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <button
          mat-raised-button
          color="primary"
          (click)="saveLanguageSetting()"
          [disabled]="isSavingLanguage"
        >
          <mat-icon>save</mat-icon>
          {{
            (isSavingLanguage
              ? "settings.language.saving"
              : "settings.language.save"
            ) | translate
          }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- ルーム情報 -->
  <div
    *ngIf="!isLoading && selectedSettingsTab === 'roomInfo' && roomInfo"
    class="settings-content"
  >
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>info</mat-icon>
          {{ "settings.roomInfo.title" | translate }}
        </mat-card-title>
        <mat-card-subtitle>
          {{ "settings.roomInfo.subtitle" | translate }}
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="room-info-content">
          <div class="room-info-item">
            <label>{{ "settings.roomInfo.roomName" | translate }}:</label>
            <span class="room-value">{{ roomInfo.name }}</span>
          </div>

          <div class="room-info-item">
            <label>{{ "settings.roomInfo.roomId" | translate }}:</label>
            <span class="room-value">{{ roomInfo.roomId }}</span>
          </div>

          <div class="room-info-item">
            <label>{{ "settings.roomInfo.password" | translate }}:</label>
            <span class="room-value">{{ roomInfo.password }}</span>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <button
          mat-raised-button
          color="primary"
          (click)="changeRoom()"
        >
          <mat-icon>swap_horiz</mat-icon>
          ルームを変更
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
