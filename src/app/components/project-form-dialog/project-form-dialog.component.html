<div class="dialog-container">
  <div class="dialog-header">
    <h2>{{ (isEditMode ? 'projectForm.editTitle' : 'projectForm.title') | translate }}</h2>
  </div>

  <div class="dialog-content">
    <form
      (ngSubmit)="onSubmit()"
      (keydown.enter)="$event.preventDefault()"
      #form="ngForm"
      class="form-container"
    >
      <!-- プロジェクト名 -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{ 'projectForm.projectName' | translate }} *</mat-label>
        <input
          matInput
          [(ngModel)]="project.projectName"
          name="projectName"
          [placeholder]="'projectForm.projectNamePlaceholder' | translate"
          required
        />
        <mat-icon matSuffix>folder</mat-icon>
      </mat-form-field>

      <!-- 概要 -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{ 'projectForm.overview' | translate }}</mat-label>
        <textarea
          matInput
          [(ngModel)]="project.overview"
          name="overview"
          [placeholder]="'projectForm.overviewPlaceholder' | translate"
          rows="3"
        ></textarea>
        <mat-icon matSuffix>description</mat-icon>
      </mat-form-field>

      <div class="date-field-group">
        <!-- 開始日 -->
        <div class="date-field">
          <label for="startDate">{{ 'projectForm.startDate' | translate }}</label>
          <div class="date-input-wrapper">
            <input
              id="startDate"
              type="date"
              [(ngModel)]="project.startDate"
              name="startDate"
              [placeholder]="'projectForm.startDateLabel' | translate"
              class="date-input"
            />
            <mat-icon class="date-icon">event</mat-icon>
          </div>
        </div>

        <!-- 終了日 -->
        <div class="date-field">
          <label for="endDate">{{ 'projectForm.endDate' | translate }}</label>
          <div class="date-input-wrapper">
            <input
              id="endDate"
              type="date"
              [(ngModel)]="project.endDate"
              name="endDate"
              [placeholder]="'projectForm.endDateLabel' | translate"
              [min]="project.startDate || ''"
              class="date-input"
            />
            <mat-icon class="date-icon">event</mat-icon>
          </div>
        </div>
      </div>

      <!-- テーマ色 -->
      <div class="theme-color-section">
        <div class="theme-color-header">
          <h3>{{ 'projectForm.themeColor' | translate }}</h3>
          <span class="helper-text">{{ 'projectForm.themeColorHelper' | translate }}</span>
        </div>
        <div class="theme-color-grid">
          <button
            type="button"
            class="theme-color-option no-color-option"
            (click)="clearThemeColor()"
            [class.selected]="isThemeColorSelected(null)"
            [matTooltip]="'projectForm.noColor' | translate"
            [attr.aria-pressed]="isThemeColorSelected(null)"
            [attr.aria-label]="('projectForm.themeColor' | translate) + ' ' + ('projectForm.noColor' | translate)"
          >
            <span>{{ 'projectForm.noColor' | translate }}</span>
          </button>
          <button
            type="button"
            class="theme-color-option"
            *ngFor="let color of themeColorOptions"
            [style.backgroundColor]="color"
            [class.selected]="isThemeColorSelected(color)"
            (click)="selectThemeColor(color)"
            matTooltip="{{ getThemeColorLabel(color) }}"
            [attr.aria-pressed]="isThemeColorSelected(color)"
            [attr.aria-label]="'テーマ色 ' + getThemeColorLabel(color)"
          >
            <mat-icon *ngIf="isThemeColorSelected(color)">check</mat-icon>
          </button>
        </div>
        <input
          type="hidden"
          name="themeColor"
          [(ngModel)]="project.themeColor"
        />
      </div>

      <!-- 責任者 -->
      <div class="member-selection responsible-selection">
        <div class="member-selection-header">
          <h3>{{ 'projectForm.responsible' | translate }}</h3>
        </div>

        <!-- ローディング表示 -->
        <div *ngIf="membersLoading" class="loading-members">
          <mat-spinner diameter="24"></mat-spinner>
          <span>{{ 'projectForm.loadingMembers' | translate }}</span>
        </div>

        <div *ngIf="!membersLoading && members.length > 0">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'projectForm.selectResponsible' | translate }}</mat-label>
            <mat-select
              [(ngModel)]="selectedResponsibleId"
              name="responsible"
              (selectionChange)="onResponsibleSelectionChange($event.value)"
              [placeholder]="'projectForm.selectResponsible' | translate"
            >
              <mat-option value="">{{ 'common.noSelection' | translate }}</mat-option>
              <mat-option *ngFor="let member of members" [value]="member.id">
                {{ member.name }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>person</mat-icon>
          </mat-form-field>

          <div *ngIf="selectedResponsible" class="selected-members-inline">
            <div class="member-chips-inline">
              <mat-chip-set>
                <mat-chip
                  [removable]="true"
                  (removed)="removeResponsible()"
                  class="member-chip-inline"
                >
                  <mat-icon matChipAvatar>workspace_premium</mat-icon>
                  <span class="member-chip-name">{{
                    selectedResponsible?.name
                  }}</span>
                  <button matChipRemove>
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip>
              </mat-chip-set>
            </div>
          </div>
        </div>

        <!-- メンバーがいない場合 -->
        <div *ngIf="!membersLoading && members.length === 0" class="no-members">
          <mat-icon class="no-members-icon">people_outline</mat-icon>
          <p>{{ 'projectForm.noMembers' | translate }}</p>
          <p>{{ 'memberManagement.addFirstMember' | translate }}</p>
        </div>
      </div>

      <!-- メンバー選択 -->
      <div class="member-selection">
        <div class="member-selection-header">
          <h3>
            {{ 'projectForm.projectMembers' | translate }}
            <span class="member-count" *ngIf="selectedMembers.length > 0">
              ({{ selectedMembers.length }})
            </span>
          </h3>
        </div>

        <!-- ローディング表示 -->
        <div *ngIf="membersLoading" class="loading-members">
          <mat-spinner diameter="24"></mat-spinner>
          <span>{{ 'projectForm.loadingMembers' | translate }}</span>
        </div>

        <!-- メンバー選択 -->
        <div *ngIf="!membersLoading && members.length > 0">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'projectForm.selectMembers' | translate }}</mat-label>
            <mat-select
              [(ngModel)]="selectedMemberIds"
              name="members"
              multiple
              (selectionChange)="onMemberSelectionChange($event.value)"
              [placeholder]="'projectForm.selectMembers' | translate"
            >
              <mat-option *ngFor="let member of members" [value]="member.id">
                {{ member.name }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>people</mat-icon>
          </mat-form-field>

          <!-- 選択されたメンバー（入力欄内に表示） -->
          <div
            *ngIf="selectedMembers.length > 0"
            class="selected-members-inline"
          >
            <div class="selected-members-header">
              <span class="member-count-text"
                >{{ selectedMembers.length }}人選択中</span
              >
            </div>
            <div class="member-chips-inline">
              <mat-chip-set>
                <mat-chip
                  *ngFor="let member of selectedMembers"
                  [removable]="true"
                  (removed)="removeMember(member)"
                  class="member-chip-inline"
                >
                  <mat-icon matChipAvatar>person</mat-icon>
                  <span class="member-chip-name">{{ member.name }}</span>
                  <button matChipRemove>
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip>
              </mat-chip-set>
            </div>
          </div>
        </div>

        <!-- メンバーがいない場合 -->
        <div *ngIf="!membersLoading && members.length === 0" class="no-members">
          <mat-icon class="no-members-icon">people_outline</mat-icon>
          <p>{{ 'projectForm.noMembers' | translate }}</p>
          <p>{{ 'memberManagement.addFirstMember' | translate }}</p>
        </div>
      </div>

      <!-- 資料添付 -->
      <div class="attachments-section">
        <div class="member-selection-header">
          <h3>{{ 'projectForm.attachments' | translate }}</h3>
          <span class="helper-text">{{ 'projectForm.attachmentHelper' | translate }}</span>
        </div>

        <div class="attachment-actions">
          <button
            mat-stroked-button
            color="primary"
            type="button"
            (click)="fileInput.click()"
          >
            <mat-icon>attach_file</mat-icon>
            {{ 'projectForm.selectFile' | translate }}
          </button>
          <input
            #fileInput
            type="file"
            multiple
            [attr.accept]="fileAccept"
            (change)="onFilesSelected($event)"
            hidden
          />
          <span class="attachment-hint">{{ 'projectForm.attachmentHint' | translate }}</span>
        </div>

        <div class="pending-files" *ngIf="pendingFiles.length > 0">
          <h4>{{ 'projectForm.uploading' | translate }}</h4>
          <div
            class="attachment-chip"
            *ngFor="let pending of pendingFiles; trackBy: trackPendingFile"
          >
            <mat-icon>upload</mat-icon>
            <span>
              {{ pending.file.name }} ({{ formatFileSize(pending.file.size) }})
            </span>
            <button
              mat-icon-button
              type="button"
              (click)="removePendingFile(pending.id)"
              [matTooltip]="'common.delete' | translate"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <div class="link-attachments">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'projectForm.attachmentName' | translate }}</mat-label>
            <input
              matInput
              [(ngModel)]="linkTitle"
              name="dialogAttachmentTitle"
              placeholder="e.g. Design Document"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'projectForm.attachmentUrl' | translate }}</mat-label>
            <input
              matInput
              [(ngModel)]="linkUrl"
              name="dialogAttachmentUrl"
              placeholder="https://example.com/document.pdf"
            />
          </mat-form-field>

          <button
            mat-stroked-button
            color="accent"
            type="button"
            (click)="addLinkAttachment()"
          >
            {{ 'projectForm.addUrl' | translate }}
          </button>
        </div>

        <div class="attachment-list" *ngIf="attachments.length > 0">
          <h4>{{ 'projectForm.registeredAttachments' | translate }}</h4>
          <div
            class="attachment-chip"
            *ngFor="let attachment of attachments; trackBy: trackAttachment"
          >
            <mat-icon>{{ attachment.type === 'link' ? 'link' : 'attach_file' }}</mat-icon>
            <a
              [href]="attachment.url"
              target="_blank"
              rel="noopener noreferrer"
            >
              {{ attachment.name }}
            </a>
            <ng-container *ngIf="attachment.type === 'file' && attachment.size">
              <span class="size-text">({{ formatFileSize(attachment.size) }})</span>
            </ng-container>
            <button
              mat-icon-button
              type="button"
              (click)="removeAttachment(attachment)"
              [matTooltip]="'common.delete' | translate"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <div class="uploading-indicator" *ngIf="isUploading">
          <mat-spinner diameter="24"></mat-spinner>
          <span>{{ 'projectForm.uploadingAttachments' | translate }}</span>
        </div>
      </div>

      <!-- タグ -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{ 'projectForm.tags' | translate }}</mat-label>
        <input
          matInput
          [(ngModel)]="project.tags"
          name="tags"
          placeholder="#UI, #Development"
        />
        <mat-icon matSuffix>tag</mat-icon>
      </mat-form-field>

      <!-- マイルストーン設定 -->
      <div class="milestones-section">
        <h3>{{ 'projectForm.milestones' | translate }}</h3>
        <div class="milestones-container">
          <div
            *ngFor="let milestone of project.milestones; let i = index"
            class="milestone-item"
          >
            <mat-form-field appearance="outline" class="milestone-date">
              <mat-label>{{ 'projectForm.date' | translate }}</mat-label>
              <input
                matInput
                type="date"
                [(ngModel)]="milestone.date"
                name="milestoneDate{{ i }}"
                #milestoneDateInput
              />
              <button
                mat-icon-button
                matSuffix
                type="button"
                (click)="openDatePicker(milestoneDateInput)"
                matTooltip="Open Calendar"
              >
                <mat-icon>event</mat-icon>
              </button>
            </mat-form-field>
            <mat-form-field appearance="outline" class="milestone-name">
              <mat-label>{{ 'projectForm.milestoneName' | translate }}</mat-label>
              <input
                matInput
                type="text"
                [(ngModel)]="milestone.name"
                name="milestoneName{{ i }}"
                [placeholder]="'projectForm.milestoneName' | translate"
              />
            </mat-form-field>
            <button
              mat-icon-button
              type="button"
              (click)="removeMilestone(i)"
              class="remove-milestone"
              color="warn"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          <button
            mat-button
            type="button"
            (click)="addMilestone()"
            class="add-milestone"
            color="primary"
          >
            <mat-icon>add</mat-icon>
            {{ 'projectForm.addMilestone' | translate }}
          </button>
        </div>
      </div>

      <!-- ボタン -->
      <div class="dialog-actions">
        <div class="dialog-actions-left">
          <button
            *ngIf="isEditMode"
            mat-raised-button
            type="button"
            color="warn"
            class="delete-button"
            (click)="confirmDeleteProject()"
          >
            <mat-icon>delete</mat-icon>
            {{ 'common.delete' | translate }}
          </button>
        </div>

        <div class="dialog-actions-right">
          <button
            mat-raised-button
            type="button"
            class="cancel-button"
            (click)="onCancel()"
          >
            {{ 'common.cancel' | translate }}
          </button>

          <button
            mat-raised-button
            type="submit"
            color="primary"
            class="save-button"
            [disabled]="!project.projectName?.trim() || isSubmitting || isUploading"
          >
            <ng-container *ngIf="!isSubmitting; else submitting">
              <mat-icon>{{ isEditMode ? "edit" : "add" }}</mat-icon>
              {{ (isEditMode ? 'common.update' : 'common.save') | translate }}
            </ng-container>
            <ng-template #submitting>
              <mat-spinner diameter="20"></mat-spinner>
              <span>{{ (isEditMode ? 'common.updating' : 'common.saving') | translate }}</span>
            </ng-template>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
