<div class="dialog-container">
  <div class="dialog-header">
    <h2>{{ isEditMode ? "プロジェクト編集" : "新規プロジェクト作成" }}</h2>
  </div>

  <div class="dialog-content">
    <form (ngSubmit)="onSubmit()" #form="ngForm" class="form-container">
      <!-- プロジェクト名 -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>プロジェクト名 *</mat-label>
        <input
          matInput
          [(ngModel)]="project.projectName"
          name="projectName"
          placeholder="例: 新商品開発プロジェクト"
          required
        />
        <mat-icon matSuffix>folder</mat-icon>
      </mat-form-field>

      <!-- 概要 -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>概要</mat-label>
        <textarea
          matInput
          [(ngModel)]="project.overview"
          name="overview"
          placeholder="プロジェクトの詳細説明を入力してください"
          rows="3"
        ></textarea>
        <mat-icon matSuffix>description</mat-icon>
      </mat-form-field>

      <!-- 開始日 -->
      <div class="date-field">
        <label for="startDate">開始日</label>
        <div class="date-input-wrapper">
          <input
            id="startDate"
            type="date"
            [(ngModel)]="project.startDate"
            name="startDate"
            placeholder="開始日を選択"
            class="date-input"
          />
          <mat-icon class="date-icon">event</mat-icon>
        </div>
      </div>

      <!-- 責任者 -->
      <div class="member-selection responsible-selection">
        <div class="member-selection-header">
          <h3>責任者</h3>
        </div>

        <!-- ローディング表示 -->
        <div *ngIf="membersLoading" class="loading-members">
          <mat-spinner diameter="24"></mat-spinner>
          <span>メンバーを読み込み中...</span>
        </div>

        <div *ngIf="!membersLoading && members.length > 0">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>責任者を選択</mat-label>
            <mat-select
              [(ngModel)]="selectedResponsibleId"
              name="responsible"
              (selectionChange)="onResponsibleSelectionChange($event.value)"
              placeholder="責任者を選択してください"
            >
              <mat-option value="">選択しない</mat-option>
              <mat-option *ngFor="let member of members" [value]="member.id">
                {{ member.name }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>person</mat-icon>
          </mat-form-field>

          <div *ngIf="selectedResponsible" class="selected-members-inline">
            <div class="member-chips-inline">
              <mat-chip-set>
                <mat-chip
                  [removable]="true"
                  (removed)="removeResponsible()"
                  class="member-chip-inline"
                >
                  <mat-icon matChipAvatar>workspace_premium</mat-icon>
                  <span class="member-chip-name">{{
                    selectedResponsible?.name
                  }}</span>
                  <button matChipRemove>
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip>
              </mat-chip-set>
            </div>
          </div>
        </div>

        <!-- メンバーがいない場合 -->
        <div *ngIf="!membersLoading && members.length === 0" class="no-members">
          <mat-icon class="no-members-icon">people_outline</mat-icon>
          <p>メンバーが登録されていません</p>
          <p>先にメンバー管理画面でメンバーを登録してください。</p>
        </div>
      </div>

      <!-- メンバー選択 -->
      <div class="member-selection">
        <div class="member-selection-header">
          <h3>
            担当メンバー
            <span class="member-count" *ngIf="selectedMembers.length > 0">
              ({{ selectedMembers.length }}人選択中)
            </span>
          </h3>
        </div>

        <!-- ローディング表示 -->
        <div *ngIf="membersLoading" class="loading-members">
          <mat-spinner diameter="24"></mat-spinner>
          <span>メンバーを読み込み中...</span>
        </div>

        <!-- メンバー選択 -->
        <div *ngIf="!membersLoading && members.length > 0">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>メンバーを選択</mat-label>
            <mat-select
              [(ngModel)]="selectedMemberIds"
              name="members"
              multiple
              (selectionChange)="onMemberSelectionChange($event.value)"
              placeholder="メンバーを選択してください（複数選択可）"
            >
              <mat-option *ngFor="let member of members" [value]="member.id">
                {{ member.name }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>people</mat-icon>
          </mat-form-field>

          <!-- 選択されたメンバー（入力欄内に表示） -->
          <div
            *ngIf="selectedMembers.length > 0"
            class="selected-members-inline"
          >
            <div class="selected-members-header">
              <span class="member-count-text"
                >{{ selectedMembers.length }}人選択中</span
              >
            </div>
            <div class="member-chips-inline">
              <mat-chip-set>
                <mat-chip
                  *ngFor="let member of selectedMembers"
                  [removable]="true"
                  (removed)="removeMember(member)"
                  class="member-chip-inline"
                >
                  <mat-icon matChipAvatar>person</mat-icon>
                  <span class="member-chip-name">{{ member.name }}</span>
                  <button matChipRemove>
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip>
              </mat-chip-set>
            </div>
          </div>
        </div>

        <!-- メンバーがいない場合 -->
        <div *ngIf="!membersLoading && members.length === 0" class="no-members">
          <mat-icon class="no-members-icon">people_outline</mat-icon>
          <p>メンバーが登録されていません</p>
          <p>先にメンバー管理画面でメンバーを登録してください。</p>
        </div>
      </div>

      <!-- 資料添付 -->
      <div class="attachments-section">
        <div class="member-selection-header">
          <h3>資料</h3>
          <span class="helper-text">1ファイル 5MB 未満・複数添付可</span>
        </div>

        <div class="attachment-actions">
          <button
            mat-stroked-button
            color="primary"
            type="button"
            (click)="fileInput.click()"
          >
            <mat-icon>attach_file</mat-icon>
            ファイルを選択
          </button>
          <input
            #fileInput
            type="file"
            multiple
            (change)="onFilesSelected($event)"
            hidden
          />
          <span class="attachment-hint">PDF / 画像 / Office ファイルなど</span>
        </div>

        <div class="pending-files" *ngIf="pendingFiles.length > 0">
          <h4>アップロード予定</h4>
          <div
            class="attachment-chip"
            *ngFor="let pending of pendingFiles; trackBy: trackPendingFile"
          >
            <mat-icon>upload</mat-icon>
            <span>
              {{ pending.file.name }} ({{ formatFileSize(pending.file.size) }})
            </span>
            <button
              mat-icon-button
              type="button"
              (click)="removePendingFile(pending.id)"
              matTooltip="削除"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <div class="link-attachments">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>資料名（任意）</mat-label>
            <input
              matInput
              [(ngModel)]="linkTitle"
              name="dialogAttachmentTitle"
              placeholder="設計資料 など"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>資料URL</mat-label>
            <input
              matInput
              [(ngModel)]="linkUrl"
              name="dialogAttachmentUrl"
              placeholder="https://example.com/document.pdf"
            />
          </mat-form-field>

          <button
            mat-stroked-button
            color="accent"
            type="button"
            (click)="addLinkAttachment()"
          >
            URLを追加
          </button>
        </div>

        <div class="attachment-list" *ngIf="attachments.length > 0">
          <h4>登録済み資料</h4>
          <div
            class="attachment-chip"
            *ngFor="let attachment of attachments; trackBy: trackAttachment"
          >
            <mat-icon>{{ attachment.type === 'link' ? 'link' : 'attach_file' }}</mat-icon>
            <a
              [href]="attachment.url"
              target="_blank"
              rel="noopener noreferrer"
            >
              {{ attachment.name }}
            </a>
            <ng-container *ngIf="attachment.type === 'file' && attachment.size">
              <span class="size-text">({{ formatFileSize(attachment.size) }})</span>
            </ng-container>
            <button
              mat-icon-button
              type="button"
              (click)="removeAttachment(attachment)"
              matTooltip="削除"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <div class="uploading-indicator" *ngIf="isUploading">
          <mat-spinner diameter="24"></mat-spinner>
          <span>添付ファイルをアップロード中...</span>
        </div>
      </div>

      <!-- タグ -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>タグ</mat-label>
        <input
          matInput
          [(ngModel)]="project.tags"
          name="tags"
          placeholder="#UI, #開発"
        />
        <mat-icon matSuffix>tag</mat-icon>
      </mat-form-field>

      <!-- マイルストーン設定 -->
      <div class="milestones-section">
        <h3>マイルストーン</h3>
        <div class="milestones-container">
          <div
            *ngFor="let milestone of project.milestones; let i = index"
            class="milestone-item"
          >
            <mat-form-field appearance="outline" class="milestone-date">
              <mat-label>日付</mat-label>
              <input
                matInput
                type="date"
                [(ngModel)]="milestone.date"
                name="milestoneDate{{ i }}"
                #milestoneDateInput
              />
              <button
                mat-icon-button
                matSuffix
                type="button"
                (click)="openDatePicker(milestoneDateInput)"
                matTooltip="カレンダーを開く"
              >
                <mat-icon>event</mat-icon>
              </button>
            </mat-form-field>
            <mat-form-field appearance="outline" class="milestone-name">
              <mat-label>マイルストーン名</mat-label>
              <input
                matInput
                type="text"
                [(ngModel)]="milestone.name"
                name="milestoneName{{ i }}"
                placeholder="マイルストーン名"
              />
            </mat-form-field>
            <button
              mat-icon-button
              type="button"
              (click)="removeMilestone(i)"
              class="remove-milestone"
              color="warn"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          <button
            mat-button
            type="button"
            (click)="addMilestone()"
            class="add-milestone"
            color="primary"
          >
            <mat-icon>add</mat-icon>
            マイルストーンを追加
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- ボタン -->
  <div class="dialog-actions">
    <!-- 編集モードの場合のみ削除ボタンを表示 -->
    <button
      *ngIf="isEditMode"
      mat-raised-button
      color="warn"
      class="delete-button"
      (click)="confirmDeleteProject()"
    >
      <mat-icon>delete</mat-icon>
      プロジェクト削除
    </button>

    <button
      mat-raised-button
      type="button"
      class="cancel-button"
      (click)="onCancel()"
    >
      キャンセル
    </button>

    <button
      mat-raised-button
      type="submit"
      color="primary"
      class="save-button"
      [disabled]="!project.projectName"
      (click)="onSubmit()"
    >
      <mat-icon>{{ isEditMode ? "edit" : "add" }}</mat-icon>
      {{ isEditMode ? "更新" : "登録" }}
    </button>
  </div>
</div>
