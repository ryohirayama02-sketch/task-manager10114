<div class="projects-overview-container">
  <div class="header">
    <h2>全プロジェクト進捗</h2>
    <div class="header-actions">
      <button
        mat-stroked-button
        color="primary"
        [matMenuTriggerFor]="sortMenu"
        class="sort-button"
      >
        <mat-icon>sort</mat-icon>
        並び替え: {{ getSortLabel(sortOption) }}
        <mat-icon class="expand-icon">arrow_drop_down</mat-icon>
      </button>
      <button mat-raised-button color="primary" (click)="openProjectForm()">
        <mat-icon>add</mat-icon>
        プロジェクトを作成
      </button>
    </div>
  </div>

  <mat-menu #sortMenu="matMenu">
    <button
      mat-menu-item
      *ngFor="let option of sortOptions"
      (click)="onSortChange(option.value)"
    >
      <span>{{ option.label }}</span>
      <mat-icon class="selected-icon" *ngIf="sortOption === option.value">
        check
      </mat-icon>
    </button>
  </mat-menu>

  <!-- ▼ プロジェクトカード一覧 -->
  <div
    *ngFor="let project of projects"
    (click)="project.id ? goToProgress(project.id) : null"
    class="project-card"
    [ngStyle]="{ '--project-theme-color': getProjectThemeColor(project) }"
    [class.completed]="
      project.id &&
      projectProgress[project.id] &&
      projectProgress[project.id].progressPercentage === 100
    "
  >
    <div class="project-info">
      <!-- ▼ プロジェクト名クリックで詳細へ -->
      <h3 class="project-title">
        {{ project.projectName || "（名称未設定）" }}
      </h3>

      <p>
        <strong>概要:</strong> {{ project.overview || "（概要未設定）" }}
      </p>
      <p>
        <strong>期間:</strong>
        {{ toDateDisplay(project.startDate) }} -
        {{ toDateDisplay(project.endDate) }}
      </p>
      <p>
        <strong>責任者:</strong> {{ project.responsible || "（責任者未設定）" }}
      </p>
      <p><strong>メンバー:</strong> {{ getMemberDisplay(project) }}</p>
    </div>

    <!-- ▼ 進捗率円グラフ -->
    <div
      class="progress-section"
      *ngIf="project.id && projectProgress[project.id]"
      [style.opacity]="
        projectProgress[project.id].progressPercentage === 100 ? '0.6' : '1'
      "
    >
      <app-progress-circle
        [percentage]="projectProgress[project.id].progressPercentage"
        [completedTasks]="projectProgress[project.id].completedTasks"
        [totalTasks]="projectProgress[project.id].totalTasks"
        [size]="80"
        [strokeWidth]="6"
      >
      </app-progress-circle>
    </div>
  </div>
</div>
