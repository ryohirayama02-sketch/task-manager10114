<div class="member-detail-container">
  <div class="header">
    <button mat-button (click)="goBack()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
      戻る
    </button>
    <h2>個別メンバーの進捗</h2>
  </div>

  <!-- ローディング表示 -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>メンバー詳細を読み込み中...</p>
  </div>

  <!-- メンバー詳細 -->
  <div *ngIf="!isLoading && memberDetail" class="member-detail-content">
    <!-- メンバー情報 -->
    <mat-card class="member-info-card">
      <mat-card-content>
        <div class="member-info">
          <h3 class="member-name">{{ memberDetail.name }}</h3>
          <div class="member-meta">
            <span class="completion-rate"
              >完了率: {{ memberDetail.completionRate }}%</span
            >
            <span class="total-tasks"
              >総タスク数: {{ memberDetail.totalTasks }}件</span
            >
          </div>
          <div class="projects">
            <strong>所属プロジェクト:</strong>
            <span
              *ngFor="let project of memberDetail.projects"
              class="project-chip"
            >
              {{ project }}
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- 優先度別統計 -->
    <mat-card class="priority-stats-card">
      <mat-card-header>
        <mat-card-title>全保有タスクのステータスと優先度</mat-card-title>
        <div class="header-actions">
          <button mat-button class="period-button">
            <mat-icon>date_range</mat-icon>
            期間
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="priority-breakdown">
          <div class="status-row priority-row">
            <div class="status-label">優先度</div>
            <div class="status-total">&nbsp;</div>
            <div class="priority-details">
              <span class="priority-label high">高</span>
              <span class="priority-label medium">中</span>
              <span class="priority-label low">低</span>
            </div>
          </div>

          <div class="status-row completed">
            <div class="status-label">完了</div>
            <div class="status-total">{{ memberDetail.completedTasks }}件</div>
            <div class="priority-details">
              <span class="priority-item high">{{
                memberDetail.completedByPriority.high
              }}</span>
              <span class="priority-item medium">{{
                memberDetail.completedByPriority.medium
              }}</span>
              <span class="priority-item low">{{
                memberDetail.completedByPriority.low
              }}</span>
            </div>
          </div>

          <div class="status-row in-progress">
            <div class="status-label">作業中</div>
            <div class="status-total">{{ memberDetail.inProgressTasks }}件</div>
            <div class="priority-details">
              <span class="priority-item high">{{
                memberDetail.inProgressByPriority.high
              }}</span>
              <span class="priority-item medium">{{
                memberDetail.inProgressByPriority.medium
              }}</span>
              <span class="priority-item low">{{
                memberDetail.inProgressByPriority.low
              }}</span>
            </div>
          </div>

          <div class="status-row not-started">
            <div class="status-label">未着手</div>
            <div class="status-total">{{ memberDetail.notStartedTasks }}件</div>
            <div class="priority-details">
              <span class="priority-item high">{{
                memberDetail.notStartedByPriority.high
              }}</span>
              <span class="priority-item medium">{{
                memberDetail.notStartedByPriority.medium
              }}</span>
              <span class="priority-item low">{{
                memberDetail.notStartedByPriority.low
              }}</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- タスク一覧 -->
    <mat-card class="tasks-card">
      <mat-card-header>
        <mat-card-title>タスク一覧</mat-card-title>
        <div class="header-actions">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>期日</mat-label>
            <mat-select [(ngModel)]="filterDueDateSort" (selectionChange)="applyTaskFilters()">
              <mat-option value="">ソートなし</mat-option>
              <mat-option value="near">近い順</mat-option>
              <mat-option value="far">遠い順</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>ステータス</mat-label>
            <mat-select [(ngModel)]="filterStatus" (selectionChange)="applyTaskFilters()" multiple>
              <mat-option value="未着手">未着手</mat-option>
              <mat-option value="作業中">作業中</mat-option>
              <mat-option value="完了">完了</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>優先度</mat-label>
            <mat-select [(ngModel)]="filterPriority" (selectionChange)="applyTaskFilters()" multiple>
              <mat-option value="高">高</mat-option>
              <mat-option value="中">中</mat-option>
              <mat-option value="低">低</mat-option>
            </mat-select>
          </mat-form-field>

          <button mat-button (click)="resetTaskFilters()">
            <mat-icon>clear</mat-icon>
            リセット
          </button>

          <button mat-button class="export-button" (click)="exportToCSV()">
            <mat-icon>download</mat-icon>
            出力
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table
            mat-table
            [dataSource]="filteredTasks"
            class="tasks-table"
          >
            <!-- プロジェクト名列 -->
            <ng-container matColumnDef="projectName">
              <th mat-header-cell *matHeaderCellDef>プロジェクト名</th>
              <td mat-cell *matCellDef="let task">
                <span
                  class="project-name-pill"
                  [ngStyle]="getProjectNameStyle(task)"
                >
                  {{ task.projectName }}
                </span>
              </td>
            </ng-container>

            <!-- タスク名列 -->
            <ng-container matColumnDef="taskName">
              <th mat-header-cell *matHeaderCellDef>タスク名</th>
              <td mat-cell *matCellDef="let task">{{ task.taskName }}</td>
            </ng-container>

            <!-- ステータス列 -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>ステータス</th>
              <td mat-cell *matCellDef="let task">
                <span
                  class="status-chip"
                  [style.background-color]="getStatusColor(task.status)"
                >
                  {{ task.status }}
                </span>
              </td>
            </ng-container>

            <!-- 期日列 -->
            <ng-container matColumnDef="dueDate">
              <th mat-header-cell *matHeaderCellDef>期日</th>
              <td mat-cell *matCellDef="let task">{{ task.dueDate }}</td>
            </ng-container>

            <!-- 優先度列 -->
            <ng-container matColumnDef="priority">
              <th mat-header-cell *matHeaderCellDef>優先度</th>
              <td mat-cell *matCellDef="let task">
                <span
                  class="priority-chip"
                  [style.background-color]="getPriorityColor(task.priority)"
                >
                  {{ task.priority }}
                </span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- メンバーが見つからない場合 -->
  <div *ngIf="!isLoading && !memberDetail" class="no-member">
    <mat-card>
      <mat-card-content>
        <div class="no-member-content">
          <mat-icon class="error-icon">error_outline</mat-icon>
          <h3>メンバーが見つかりません</h3>
          <p>指定されたメンバーのタスクが見つかりません。</p>
          <button mat-button (click)="goBack()" color="primary">戻る</button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
