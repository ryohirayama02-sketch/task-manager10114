<h2 class="calendar-title">{{ 'calendar.title' | translate }}</h2>

<!-- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒœã‚¿ãƒ³ -->
<div *ngIf="!isOnline" class="offline-task-add">
  <button mat-raised-button color="primary" (click)="openOfflineTaskDialog()">
    <mat-icon>add</mat-icon>
    {{ 'calendar.offlineTaskAdd' | translate }}
  </button>
  <p class="offline-note">{{ 'calendar.offlineNote' | translate }}</p>
</div>

<!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<div class="controls-section" style="justify-content: space-between; align-items: flex-start;">
  <div class="project-selector">
    <h3>{{ 'calendar.projectSelector.title' | translate }}</h3>
    <div class="project-checkboxes">
      <mat-checkbox
        *ngFor="let project of projects"
        [checked]="project.id ? isProjectSelected(project.id) : false"
        (change)="project.id ? toggleProjectSelection(project.id) : null"
        class="project-checkbox"
      >
        {{ project.projectName }}
      </mat-checkbox>
    </div>
    <div class="project-selection-actions">
      <button mat-stroked-button (click)="selectAllProjects()">
        {{ 'calendar.projectSelector.selectAll' | translate }}
      </button>
      <button mat-stroked-button (click)="clearProjectSelection()">
        {{ 'calendar.projectSelector.clearAll' | translate }}
      </button>
    </div>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="filter-section">
    <mat-form-field appearance="outline">
      <mat-label>{{ 'calendar.filter.status' | translate }}</mat-label>
      <mat-select [(ngModel)]="filterStatus" (selectionChange)="applyFilters()" multiple>
        <mat-option value="æœªç€æ‰‹">æœªç€æ‰‹</mat-option>
        <mat-option value="ä½œæ¥­ä¸­">ä½œæ¥­ä¸­</mat-option>
        <mat-option value="å®Œäº†">å®Œäº†</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>{{ 'calendar.filter.priority' | translate }}</mat-label>
      <mat-select
        [(ngModel)]="filterPriority"
        (selectionChange)="applyFilters()"
        multiple
      >
        <mat-option value="é«˜">é«˜</mat-option>
        <mat-option value="ä¸­">ä¸­</mat-option>
        <mat-option value="ä½">ä½</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>{{ 'calendar.filter.assignee' | translate }}</mat-label>
      <mat-select
        [(ngModel)]="filterAssignee"
        (selectionChange)="applyFilters()"
        multiple
      >
        <mat-option
          *ngFor="let assignee of getUniqueAssignees()"
          [value]="assignee"
        >
          {{ assignee }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-button (click)="resetFilters()">{{ 'calendar.filter.reset' | translate }}</button>
  </div>
</div>

<!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
<div class="action-buttons">
  <div class="view-controls">
    <mat-button-toggle-group
      name="viewMode"
      [(ngModel)]="viewMode"
      (change)="changeViewMode($event.value)"
    >
      <mat-button-toggle value="day">æ—¥</mat-button-toggle>
      <mat-button-toggle value="week">é€±</mat-button-toggle>
      <mat-button-toggle value="month">æœˆ</mat-button-toggle>
    </mat-button-toggle-group>
  </div>
  <button mat-raised-button color="primary" (click)="openProjectDialog()">
    + {{ 'calendar.actionButtons.addProject' | translate }}
  </button>
</div>

<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
<div class="calendar-container">
  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="calendar-header">
    <button mat-icon-button (click)="changeDate(-1)">
      <mat-icon>chevron_left</mat-icon>
    </button>
    <h3>{{ getDisplayName() }}</h3>
    <button mat-icon-button (click)="changeDate(1)">
      <mat-icon>chevron_right</mat-icon>
    </button>
    <button mat-button (click)="goToCurrentDate()">{{ 'calendar.header.today' | translate }}</button>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ -->
  <div
    class="calendar-weekdays"
    [ngClass]="'view-' + viewMode"
    *ngIf="viewMode !== 'month'"
  >
    <div *ngFor="let date of calendarDays" class="week-day">
      {{ weekDays[date.getDay()] }}
    </div>
  </div>
  <div class="calendar-grid" [ngClass]="'view-' + viewMode">
    <!-- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœˆè¡¨ç¤ºã®ã¿ï¼‰ -->
    <ng-container *ngIf="viewMode === 'month'">
      <div *ngFor="let day of weekDays" class="week-day">{{ day }}</div>
    </ng-container>

    <div
      *ngFor="let date of calendarDays"
      class="calendar-day"
      [ngClass]="{
        today: isToday(date),
        'other-month': !isCurrentMonth(date) && viewMode === 'month',
        selected: isSelectedDate(date)
      }"
      (click)="onDateSelected(date)"
    >
      <div class="day-number">
        {{ date.getDate() }}
        <!-- ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¡¨ç¤º -->
        <ng-container *ngIf="getMilestonesForDate(date) as milestones">
          <div
            *ngIf="milestones.length > 0"
            class="milestone-flag"
            (mouseenter)="showMilestoneTooltip($event, milestones)"
            (mouseleave)="hideMilestoneTooltip()"
          >
            ğŸš©
          </div>
        </ng-container>
      </div>
      <div class="day-tasks">
        <div
          *ngFor="let task of getTasksForDate(date)"
          class="task-item"
          [style.background-color]="statusColors[task.status] || '#e0e0e0'"
          [style.border-left]="
            '4px solid ' + (statusColors[task.status] || '#fdd6d5')
          "
          [style.color]="statusTextColors[task.status] || '#212121'"
          [title]="
            task.taskName + ' (' + task.status + ') - æœŸé™: ' + task.dueDate
          "
          (click)="openTaskDetail(task)"
        >
          <div class="task-name">{{ task.taskName }}</div>
          <div class="task-project">{{ task.projectName }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å‡¡ä¾‹ -->
<div class="legend">
  <h4>{{ 'calendar.legend.status' | translate }}</h4>
  <div class="legend-items">
    <div class="legend-item">
      <div
        class="legend-color"
        [style.background-color]="statusColors['æœªç€æ‰‹']"
      ></div>
      <span>{{ 'calendar.legend.status.notStarted' | translate }}</span>
    </div>
    <div class="legend-item">
      <div
        class="legend-color"
        [style.background-color]="statusColors['ä½œæ¥­ä¸­']"
      ></div>
      <span>{{ 'calendar.legend.status.inProgress' | translate }}</span>
    </div>
    <div class="legend-item">
      <div
        class="legend-color"
        [style.background-color]="statusColors['å®Œäº†']"
      ></div>
      <span>{{ 'calendar.legend.status.completed' | translate }}</span>
    </div>
  </div>
</div>

<!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— -->
<div
  *ngIf="tooltipVisible"
  class="milestone-tooltip"
  [style.left.px]="tooltipPosition.x"
  [style.top.px]="tooltipPosition.y"
>
  <div class="tooltip-header">
    <span class="tooltip-icon">ğŸš©</span>
    <span class="tooltip-title">{{ 'calendar.milestoneTooltip.title' | translate }}</span>
  </div>
  <div class="tooltip-content">
    <div class="tooltip-item" *ngFor="let milestone of tooltipMilestones">
      <div class="tooltip-project">{{ milestone.projectName }}</div>
      <div class="tooltip-name">{{ milestone.name }}</div>
      <div class="tooltip-date">
        {{ milestone.date | date : "yyyy/MM/dd" }}
      </div>
    </div>
  </div>
  <div class="tooltip-arrow"></div>
</div>
