<h2>カレンダー式課題管理</h2>

<!-- オフライン時のタスク追加ボタン -->
<div *ngIf="!isOnline" class="offline-task-add">
  <button mat-raised-button color="primary" (click)="openOfflineTaskDialog()">
    <mat-icon>add</mat-icon>
    オフラインでタスク追加
  </button>
  <p class="offline-note">オフライン時は簡易的なタスク追加のみ可能です</p>
</div>

<!-- プロジェクト選択とフィルター -->
<div class="controls-section">
  <div class="project-selector">
    <h3>表示するプロジェクトを選択</h3>
    <div class="project-checkboxes">
      <mat-checkbox
        *ngFor="let project of projects"
        [checked]="project.id ? isProjectSelected(project.id) : false"
        (change)="project.id ? toggleProjectSelection(project.id) : null"
        class="project-checkbox"
      >
        {{ project.projectName }}
      </mat-checkbox>
    </div>
    <div class="project-selection-actions">
      <button mat-stroked-button (click)="selectAllProjects()">
        すべてにチェック
      </button>
      <button mat-stroked-button (click)="clearProjectSelection()">
        すべてのチェックをクリア
      </button>
    </div>
  </div>

  <!-- フィルター -->
  <div class="filter-section">
    <mat-form-field appearance="outline" style="width: 150px">
      <mat-label>優先度</mat-label>
      <mat-select
        [(ngModel)]="filterPriority"
        (selectionChange)="applyFilters()"
      >
        <mat-option value="">すべて</mat-option>
        <mat-option value="高">高</mat-option>
        <mat-option value="中">中</mat-option>
        <mat-option value="低">低</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" style="width: 150px">
      <mat-label>担当者</mat-label>
      <mat-select
        [(ngModel)]="filterAssignee"
        (selectionChange)="applyFilters()"
      >
        <mat-option value="">すべて</mat-option>
        <mat-option
          *ngFor="let assignee of getUniqueAssignees()"
          [value]="assignee"
        >
          {{ assignee }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" style="width: 150px">
      <mat-label>ステータス</mat-label>
      <mat-select [(ngModel)]="filterStatus" (selectionChange)="applyFilters()">
        <mat-option value="">すべて</mat-option>
        <mat-option value="未着手">未着手</mat-option>
        <mat-option value="作業中">作業中</mat-option>
        <mat-option value="完了">完了</mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-button (click)="resetFilters()">フィルターリセット</button>
  </div>
</div>

<!-- アクションボタン -->
<div class="action-buttons">
  <div class="view-controls">
    <mat-button-toggle-group
      name="viewMode"
      [(ngModel)]="viewMode"
      (change)="changeViewMode($event.value)"
    >
      <mat-button-toggle value="day">日</mat-button-toggle>
      <mat-button-toggle value="week">週</mat-button-toggle>
      <mat-button-toggle value="month">月</mat-button-toggle>
    </mat-button-toggle-group>
  </div>
  <button mat-raised-button color="primary" (click)="openProjectDialog()">
    + プロジェクト
  </button>
</div>

<!-- カレンダー -->
<div class="calendar-container">
  <!-- カレンダーヘッダー -->
  <div class="calendar-header">
    <button mat-icon-button (click)="changeDate(-1)">
      <mat-icon>chevron_left</mat-icon>
    </button>
    <h3>{{ getDisplayName() }}</h3>
    <button mat-icon-button (click)="changeDate(1)">
      <mat-icon>chevron_right</mat-icon>
    </button>
    <button mat-button (click)="goToCurrentDate()">今日</button>
  </div>

  <!-- カレンダーグリッド -->
  <div class="calendar-grid" [ngClass]="'view-' + viewMode">
    <!-- 曜日ヘッダー（月表示のみ） -->
    <ng-container *ngIf="viewMode === 'month'">
      <div *ngFor="let day of weekDays" class="week-day">{{ day }}</div>
    </ng-container>

    <div
      *ngFor="let date of calendarDays"
      class="calendar-day"
      [ngClass]="{
        today: isToday(date),
        'other-month': !isCurrentMonth(date) && viewMode === 'month',
        selected: isSelectedDate(date)
      }"
      (click)="onDateSelected(date)"
    >
      <div class="day-number">
        {{ date.getDate() }}
        <!-- マイルストーン表示 -->
        <div
          *ngFor="let milestone of getMilestonesForDate(date)"
          class="milestone-flag"
          (mouseenter)="showMilestoneTooltip($event, milestone)"
          (mouseleave)="hideMilestoneTooltip()"
        >
          🚩
        </div>
      </div>
      <div class="day-tasks">
        <div
          *ngFor="let task of getTasksForDate(date)"
          class="task-item"
          [style.background-color]="statusColors[task.status] || '#e0e0e0'"
          [style.border-left]="'4px solid ' + (statusColors[task.status] || '#e0e0e0')"
          [title]="
            task.taskName + ' (' + task.status + ') - 期限: ' + task.dueDate
          "
          (click)="openTaskDetail(task)"
        >
          <div class="task-name">{{ task.taskName }}</div>
          <div class="task-project">{{ task.projectName }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 凡例 -->
<div class="legend">
  <h4>ステータス</h4>
  <div class="legend-items">
    <div class="legend-item">
      <div class="legend-color" style="background-color: #ef9a9a"></div>
      <span>未着手</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #81c784"></div>
      <span>作業中</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #64b5f6"></div>
      <span>完了</span>
    </div>
  </div>
</div>

<!-- カスタムツールチップ -->
<div
  *ngIf="tooltipVisible"
  class="milestone-tooltip"
  [style.left.px]="tooltipPosition.x"
  [style.top.px]="tooltipPosition.y"
>
  <div class="tooltip-header">
    <span class="tooltip-icon">🚩</span>
    <span class="tooltip-title">マイルストーン</span>
  </div>
  <div class="tooltip-content">
    <div class="tooltip-project">{{ tooltipMilestone?.projectName }}</div>
    <div class="tooltip-name">{{ tooltipMilestone?.name }}</div>
    <div class="tooltip-date">
      {{ tooltipMilestone?.date | date : "yyyy/MM/dd" }}
    </div>
  </div>
  <div class="tooltip-arrow"></div>
</div>
