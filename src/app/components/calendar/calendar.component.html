<h2 class="calendar-title">{{ "calendar.title" | translate }}</h2>

<!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠžã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<div
  class="controls-section"
  style="justify-content: space-between; align-items: flex-start"
>
  <div class="project-selector">
    <h3>{{ "calendar.projectSelector.title" | translate }}</h3>
    <div class="project-checkboxes">
      <mat-checkbox
        *ngFor="let project of projects"
        [checked]="project.id ? isProjectSelected(project.id) : false"
        (change)="project.id ? toggleProjectSelection(project.id) : null"
        class="project-checkbox"
      >
        {{ project.projectName }}
      </mat-checkbox>
    </div>
    <div class="project-selection-actions">
      <div class="project-action-row">
        <button mat-stroked-button (click)="selectAllProjects()">
          {{ "calendar.projectSelector.selectAll" | translate }}
        </button>
        <button mat-stroked-button (click)="clearProjectSelection()">
          {{ "calendar.projectSelector.clearAll" | translate }}
        </button>
      </div>
      <div class="create-project-wrapper">
        <button
          mat-stroked-button
          class="create-project-button"
          [disabled]="!hasMembers"
          (click)="openProjectDialog()"
        >
          ï¼‹{{ "calendar.actionButtons.addProject" | translate }}
        </button>
        <span *ngIf="!hasMembers" class="member-required-message">
          {{ "common.memberRequiredForProject" | translate }}
        </span>
      </div>
    </div>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="filter-section">
    <mat-form-field appearance="outline">
      <mat-select
        [(ngModel)]="filterStatus"
        (selectionChange)="applyFilters()"
        multiple
        [placeholder]="'calendar.filter.status' | translate"
      >
        <mat-option [value]="getStatusValue('notStarted')">{{
          getStatusDisplay("notStarted")
        }}</mat-option>
        <mat-option [value]="getStatusValue('inProgress')">{{
          getStatusDisplay("inProgress")
        }}</mat-option>
        <mat-option [value]="getStatusValue('completed')">{{
          getStatusDisplay("completed")
        }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-select
        [(ngModel)]="filterPriority"
        (selectionChange)="applyFilters()"
        multiple
        [placeholder]="'calendar.filter.priority' | translate"
      >
        <mat-option [value]="getPriorityValue('high')">{{
          getPriorityDisplay("high")
        }}</mat-option>
        <mat-option [value]="getPriorityValue('medium')">{{
          getPriorityDisplay("medium")
        }}</mat-option>
        <mat-option [value]="getPriorityValue('low')">{{
          getPriorityDisplay("low")
        }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-select
        [(ngModel)]="filterAssignee"
        (selectionChange)="applyFilters()"
        multiple
        [placeholder]="'calendar.filter.assignee' | translate"
      >
        <mat-option
          *ngFor="let assignee of getUniqueAssignees()"
          [value]="assignee"
        >
          {{ assignee }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-stroked-button (click)="resetFilters()">
      {{ "calendar.filter.reset" | translate }}
    </button>
  </div>
</div>

<!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
<div class="action-buttons">
  <div class="view-controls">
    <mat-button-toggle-group
      name="viewMode"
      [(ngModel)]="viewMode"
      (change)="changeViewMode($event.value)"
    >
      <mat-button-toggle value="day">{{
        getViewModeLabel("day")
      }}</mat-button-toggle>
      <mat-button-toggle value="week">{{
        getViewModeLabel("week")
      }}</mat-button-toggle>
      <mat-button-toggle value="month">{{
        getViewModeLabel("month")
      }}</mat-button-toggle>
    </mat-button-toggle-group>
  </div>
</div>

<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
<div class="calendar-container">
  <!-- å‡¡ä¾‹ -->
  <div class="legend">
    <h4>{{ "calendar.legend.status" | translate }}</h4>
    <div class="legend-items">
      <div class="legend-item">
        <div
          class="legend-color"
          [style.background-color]="statusColors[getStatusValue('notStarted')]"
        ></div>
        <span>{{ "calendar.legend.status.notStarted" | translate }}</span>
      </div>
      <div class="legend-item">
        <div
          class="legend-color"
          [style.background-color]="statusColors[getStatusValue('inProgress')]"
        ></div>
        <span>{{ "calendar.legend.status.inProgress" | translate }}</span>
      </div>
      <div class="legend-item">
        <div
          class="legend-color"
          [style.background-color]="statusColors[getStatusValue('completed')]"
        ></div>
        <span>{{ "calendar.legend.status.completed" | translate }}</span>
      </div>
    </div>
  </div>
  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="calendar-header">
    <button
      mat-icon-button
      (click)="changeDate(-1)"
      [disabled]="viewMode === 'month' && !canMoveToPreviousMonth()"
    >
      <mat-icon>chevron_left</mat-icon>
    </button>
    <h3>{{ getDisplayName() }}</h3>
    <button
      mat-icon-button
      (click)="changeDate(1)"
      [disabled]="viewMode === 'month' && !canMoveToNextMonth()"
    >
      <mat-icon>chevron_right</mat-icon>
    </button>
    <button mat-button (click)="goToCurrentDate()">
      {{ "calendar.header.today" | translate }}
    </button>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ -->
  <div
    class="calendar-weekdays"
    [ngClass]="'view-' + viewMode"
    *ngIf="viewMode !== 'month'"
  >
    <div *ngFor="let date of calendarDays" class="week-day">
      {{ getWeekDays()[date.getDay()] }}
    </div>
  </div>
  <div class="calendar-grid" [ngClass]="'view-' + viewMode">
    <!-- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœˆè¡¨ç¤ºã®ã¿ï¼‰ -->
    <ng-container *ngIf="viewMode === 'month'">
      <div *ngFor="let day of getWeekDays()" class="week-day">{{ day }}</div>
    </ng-container>

    <div
      *ngFor="let date of calendarDays"
      class="calendar-day"
      [ngClass]="{
        today: isToday(date),
        'other-month': !isCurrentMonth(date) && viewMode === 'month',
        selected: isSelectedDate(date)
      }"
      (click)="onDateSelected(date)"
    >
      <div class="day-number">
        {{ date.getDate() }}
        <!-- ãƒžã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¡¨ç¤º -->
        <ng-container *ngIf="getMilestonesForDate(date) as milestones">
          <div
            *ngIf="milestones.length > 0"
            class="milestone-flag"
            (click)="toggleMilestoneTooltip($event, milestones)"
          >
            ðŸš©
          </div>
        </ng-container>
      </div>
      <div class="day-tasks">
        <div
          *ngFor="let task of getDisplayTasksForDate(date)"
          class="task-item"
          [style.background-color]="statusColors[task.status] || '#e0e0e0'"
          [style.border-left]="
            '4px solid ' + (statusColors[task.status] || '#fdd6d5')
          "
          [style.color]="statusTextColors[task.status] || '#212121'"
          [title]="getTaskTooltip(task)"
          (click)="openTaskDetail(task)"
        >
          <div class="task-name">{{ task.taskName }}</div>
          <div class="task-project" *ngIf="task.projectName">
            <mat-icon class="project-icon">folder</mat-icon>
            <span class="project-name-text">{{ task.projectName }}</span>
          </div>
        </div>
        <div
          *ngIf="getRemainingTasksCount(date) > 0"
          class="task-item task-item-more"
          [style.background-color]="'#f5f5f5'"
          [style.border-left]="'4px solid #ccc'"
          [style.color]="'#666'"
        >
          <div class="task-name">
            {{ getRemainingTasksText(getRemainingTasksCount(date)) }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— -->
<div
  *ngIf="tooltipVisible"
  #tooltip
  class="milestone-tooltip"
  [style.left.px]="tooltipPosition.x"
  [style.top.px]="tooltipPosition.y"
>
  <div class="tooltip-header">
    <span class="tooltip-icon">ðŸš©</span>
    <span class="tooltip-title">{{
      "calendar.milestoneTooltip.title" | translate
    }}</span>
  </div>
  <div class="tooltip-content">
    <div class="tooltip-item" *ngFor="let milestone of tooltipMilestones">
      <div class="tooltip-project">{{ milestone.projectName }}</div>
      <div class="tooltip-name">{{ milestone.name }}</div>
      <div class="tooltip-date">
        {{ milestone.date | date : "yyyy/MM/dd" }}
      </div>
    </div>
  </div>
  <div class="tooltip-arrow"></div>
</div>
