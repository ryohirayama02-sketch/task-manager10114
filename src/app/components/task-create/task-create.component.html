<div class="page-header" [style.background]="projectThemeColor">
  <button mat-button (click)="goBack()" class="back-button">
    <mat-icon>arrow_back</mat-icon>
    {{ 'taskCreate.back' | translate }}
  </button>
  <h2>
    {{ isSubtaskCreation ? ('taskCreate.createSubtask' | translate) : ('taskCreate.title' | translate) }}
  </h2>
</div>

<div class="task-create-container">
  <mat-card class="task-form-card">
    <mat-card-header>
      <h3>
        {{ isSubtaskCreation ? (parentTaskName ? parentTaskName + ' - ' + ('taskCreate.createSubtask' | translate) : ('taskCreate.createSubtask' | translate)) : (projectName ? projectName + ' - ' + ('taskCreate.title' | translate) : ('taskCreate.title' | translate)) }}
      </h3>
    </mat-card-header>

    <mat-card-content>
      <form (ngSubmit)="save()" #taskCreateForm="ngForm">
        <!-- è¦ªã‚¿ã‚¹ã‚¯æƒ…å ±è¡¨ç¤ºï¼ˆã‚µãƒ–ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã®ã¿ï¼‰ -->
        <div *ngIf="isSubtaskCreation" class="parent-task-info">
          <p class="info-line">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: <strong>{{ projectName }}</strong></p>
          <p class="info-line">è¦ªã‚¿ã‚¹ã‚¯å: <strong>{{ parentTaskName }}</strong></p>
        </div>

        <!-- ã‚¿ã‚¹ã‚¯å -->
        <mat-form-field appearance="outline" class="full-width-field">
          <mat-label>{{ isSubtaskCreation ? 'å­ã‚¿ã‚¹ã‚¯å' : ('taskCreate.taskName' | translate) }}</mat-label>
          <input
            matInput
            [(ngModel)]="taskForm.taskName"
            name="taskName"
            required
            maxlength="50"
          />
        </mat-form-field>

        <!-- èª¬æ˜ -->
        <mat-form-field appearance="outline" class="full-width-field">
          <mat-label>{{ 'taskCreate.description' | translate }}</mat-label>
          <textarea
            matInput
            rows="3"
            [(ngModel)]="taskForm.description"
            name="description"
            placeholder="ã‚¿ã‚¹ã‚¯ã®è©³ç´°èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ200æ–‡å­—ä»¥å†…ï¼‰"
            maxlength="200"
          ></textarea>
          <mat-hint align="end">{{ (taskForm.description || '').length }}/200</mat-hint>
        </mat-form-field>

        <!-- æ—¥ä»˜ç¯„å›² -->
        <div class="date-row">
          <div class="date-field">
            <label for="startDate">{{ 'taskCreate.startDate' | translate }}</label>
            <div class="date-input-wrapper">
              <input
                id="startDate"
                class="date-input"
                type="date"
                [(ngModel)]="taskForm.startDate"
                name="startDate"
                max="9999-12-31"
              />
            </div>
          </div>

          <div class="date-field">
            <label for="dueDate">{{ 'taskCreate.dueDate' | translate }}</label>
            <div class="date-input-wrapper">
              <input
                id="dueDate"
                class="date-input"
                type="date"
                [(ngModel)]="taskForm.dueDate"
                name="dueDate"
                [min]="taskForm.startDate || ''"
                max="9999-12-31"
              />
            </div>
          </div>
        </div>

        <!-- æ‹…å½“è€… -->
        <mat-form-field appearance="outline" class="full-width-field">
          <mat-label>{{ 'taskCreate.assignee' | translate }}</mat-label>
          <mat-select
            [(ngModel)]="selectedMemberIds"
            name="assignee"
            multiple
            (ngModelChange)="onMembersSelectionChange($event)"
          >
            <mat-option *ngFor="let member of members" [value]="member.id">
              {{ member.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <mat-form-field appearance="outline" class="full-width-field">
          <mat-label>{{ 'taskCreate.status' | translate }}</mat-label>
          <mat-select [(ngModel)]="taskForm.status" name="status">
            <mat-option *ngFor="let status of statusOptions" [value]="status">
              {{ status }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- å„ªå…ˆåº¦ -->
        <mat-form-field appearance="outline" class="full-width-field">
          <mat-label>{{ 'taskCreate.priority' | translate }}</mat-label>
          <mat-select [(ngModel)]="taskForm.priority" name="priority">
            <mat-option *ngFor="let priority of priorityOptions" [value]="priority">
              {{ priority }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- è³‡æ–™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="resources-section">
          <label><strong>ğŸ“ {{ 'taskCreate.resources' | translate }}</strong></label>
          <div class="resources-action-row">
            <button
              mat-stroked-button
              type="button"
              (click)="fileInput.click()"
              [disabled]="isUploading"
            >
              {{ 'taskCreate.addFile' | translate }}
            </button>
            <input
              #fileInput
              type="file"
              multiple
              [accept]="fileAccept"
              (change)="onFilesSelected($event)"
              hidden
            />
            <mat-form-field appearance="outline" class="url-input-field">
              <mat-label>{{ 'taskCreate.enterUrl' | translate }}</mat-label>
              <input
                matInput
                [(ngModel)]="newUrlInput"
                placeholder="https://example.com"
                (keyup.enter)="addUrl(newUrlInput)"
                name="newUrl"
              />
            </mat-form-field>
            <button
              mat-stroked-button
              type="button"
              (click)="addUrl(newUrlInput)"
            >
              {{ 'taskCreate.add' | translate }}
            </button>
          </div>

          <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º -->
          <div class="pending-files" *ngIf="pendingFiles.length > 0">
            <p class="pending-label">{{ 'taskCreate.uploadingFiles' | translate }}:</p>
            <div class="pending-files-list">
              <div
                class="pending-file-item"
                *ngFor="let pending of pendingFiles"
              >
                <mat-icon class="pending-icon">file_upload</mat-icon>
                <span class="pending-filename">{{ pending.file.name }}</span>
                <span class="pending-size">({{ formatFileSize(pending.file.size) }})</span>
              </div>
            </div>
          </div>

          <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã¨URLã®ãƒªã‚¹ãƒˆè¡¨ç¤º -->
          <div
            class="resources-container"
            *ngIf="
              (pendingFiles && pendingFiles.length > 0) ||
              (taskForm.urls && taskForm.urls.length > 0)
            "
          >
            <div class="resources-list">
              <!-- ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ« -->
              <div
                class="resource-item pending"
                *ngFor="let pending of pendingFiles"
              >
                <span class="resource-icon">ğŸ“</span>
                <span class="resource-name">{{ pending.file.name }}</span>
                <span class="resource-size">({{ formatFileSize(pending.file.size) }})</span>
                <button
                  mat-icon-button
                  type="button"
                  (click)="removePendingFile(pending.id)"
                  class="resource-remove"
                  tabindex="-1"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
              <!-- URLãƒªãƒ³ã‚¯ -->
              <div
                class="resource-item"
                *ngFor="let url of taskForm.urls || []"
              >
                <span class="resource-icon">ğŸ”—</span>
                <a
                  [href]="url"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="resource-link"
                >
                  {{ url }}
                </a>
                <button
                  mat-icon-button
                  type="button"
                  (click)="removeUrl(url)"
                  class="resource-remove"
                  tabindex="-1"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ã‚¿ã‚° -->
        <div class="tag-section">
          <label>{{ 'taskCreate.tags' | translate }}</label>
          <mat-chip-set>
            <mat-chip
              *ngFor="let tag of taskForm.tags"
              removable
              (removed)="removeTag(tag)"
            >
              {{ tag }}
              <mat-icon matChipRemove>close</mat-icon>
            </mat-chip>
          </mat-chip-set>
          <mat-form-field appearance="outline" class="tag-input-field">
            <mat-label>{{ 'taskCreate.addTag' | translate }}</mat-label>
            <input
              matInput
              #tagInput
              placeholder="{{ 'taskCreate.enterTag' | translate }}ï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰"
              (keydown.enter)="onTagInputEnter($event, tagInput)"
              maxlength="20"
            />
            <mat-hint align="end">{{ tagInput.value?.length || 0 }}/20</mat-hint>
          </mat-form-field>
        </div>

        <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº -->
        <div class="calendar-sync-section">
          <label>
            <input
              type="checkbox"
              [(ngModel)]="taskForm.calendarSyncEnabled"
              name="calendarSyncEnabled"
            />
            {{ 'taskCreate.calendarSync' | translate }}
          </label>
        </div>

        <!-- ãƒœã‚¿ãƒ³ç¾¤ -->
        <div class="form-actions">
          <button
            mat-raised-button
            type="button"
            (click)="cancel()"
            [disabled]="isSaving"
          >
            {{ 'taskCreate.cancel' | translate }}
          </button>
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="isSaving"
          >
            <mat-icon *ngIf="isSaving">schedule</mat-icon>
            {{ isSaving ? ('taskCreate.saving' | translate) : (isSubtaskCreation ? 'ä¿å­˜' : ('taskCreate.createTask' | translate)) }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
