<div class="page-header">
  <button mat-button (click)="goBack()" class="back-button">
    <mat-icon>arrow_back</mat-icon>
    {{ 'taskCreate.back' | translate }}
  </button>
  <h2>{{ 'taskCreate.title' | translate }}</h2>
</div>

<div class="task-create-container">
  <mat-card class="task-form-card">
    <mat-card-header>
      <h3>{{ projectName ? projectName + ' - ' + ('taskCreate.title' | translate) : ('taskCreate.title' | translate) }}</h3>
    </mat-card-header>

    <mat-card-content>
      <form (ngSubmit)="save()" #taskCreateForm="ngForm">
        <!-- タスク名 -->
        <mat-form-field appearance="outline" class="full-width-field">
          <mat-label>{{ 'taskCreate.taskName' | translate }}</mat-label>
          <input
            matInput
            [(ngModel)]="taskForm.taskName"
            name="taskName"
            required
          />
        </mat-form-field>

        <!-- 説明 -->
        <mat-form-field appearance="outline" class="full-width-field">
          <mat-label>{{ 'taskCreate.description' | translate }}</mat-label>
          <textarea
            matInput
            rows="3"
            [(ngModel)]="taskForm.description"
            name="description"
          ></textarea>
        </mat-form-field>

        <!-- 日付範囲 -->
        <div class="date-row">
          <div class="date-field">
            <label for="startDate">{{ 'taskCreate.startDate' | translate }}</label>
            <div class="date-input-wrapper">
              <input
                id="startDate"
                class="date-input"
                type="date"
                [(ngModel)]="taskForm.startDate"
                name="startDate"
              />
            </div>
          </div>

          <div class="date-field">
            <label for="dueDate">{{ 'taskCreate.dueDate' | translate }}</label>
            <div class="date-input-wrapper">
              <input
                id="dueDate"
                class="date-input"
                type="date"
                [(ngModel)]="taskForm.dueDate"
                name="dueDate"
              />
            </div>
          </div>
        </div>

        <!-- 担当者 -->
        <mat-form-field appearance="outline" class="full-width-field">
          <mat-label>{{ 'taskCreate.assignee' | translate }}</mat-label>
          <mat-select
            [(ngModel)]="selectedMemberIds"
            name="assignee"
            multiple
            (ngModelChange)="onMembersSelectionChange($event)"
          >
            <mat-option *ngFor="let member of members" [value]="member.id">
              {{ member.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- ステータス -->
        <mat-form-field appearance="outline" class="full-width-field">
          <mat-label>{{ 'taskCreate.status' | translate }}</mat-label>
          <mat-select [(ngModel)]="taskForm.status" name="status">
            <mat-option *ngFor="let status of statusOptions" [value]="status">
              {{ status }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- 優先度 -->
        <mat-form-field appearance="outline" class="full-width-field">
          <mat-label>{{ 'taskCreate.priority' | translate }}</mat-label>
          <mat-select [(ngModel)]="taskForm.priority" name="priority">
            <mat-option *ngFor="let priority of priorityOptions" [value]="priority">
              {{ priority }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- タグ -->
        <div class="tag-section">
          <label>{{ 'taskCreate.tags' | translate }}</label>
          <div class="tag-input-row">
            <mat-form-field appearance="outline" class="tag-input-field">
              <mat-label>{{ 'taskCreate.addTag' | translate }}</mat-label>
              <input
                matInput
                [(ngModel)]="newTag"
                name="newTag"
                placeholder="{{ 'taskCreate.enterTag' | translate }}"
                (keyup.enter)="addTag()"
              />
            </mat-form-field>
            <button
              mat-icon-button
              type="button"
              (click)="addTag()"
              [disabled]="!newTag"
            >
              <mat-icon>add</mat-icon>
            </button>
          </div>
          <mat-chip-set *ngIf="taskForm.tags.length > 0">
            <mat-chip
              *ngFor="let tag of taskForm.tags"
              removable
              (removed)="removeTag(tag)"
            >
              {{ tag }}
              <mat-icon matChipRemove>close</mat-icon>
            </mat-chip>
          </mat-chip-set>
        </div>

        <!-- カレンダー連携 -->
        <div class="calendar-sync-section">
          <label>
            <input
              type="checkbox"
              [(ngModel)]="taskForm.calendarSyncEnabled"
              name="calendarSyncEnabled"
            />
            {{ 'taskCreate.calendarSync' | translate }}
          </label>
        </div>

        <!-- ボタン群 -->
        <div class="form-actions">
          <button
            mat-raised-button
            type="button"
            (click)="cancel()"
            [disabled]="isSaving"
          >
            {{ 'taskCreate.cancel' | translate }}
          </button>
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="isSaving"
          >
            <mat-icon *ngIf="isSaving">schedule</mat-icon>
            {{ isSaving ? ('taskCreate.saving' | translate) : ('taskCreate.createTask' | translate) }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
